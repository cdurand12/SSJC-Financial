/*! portfolio-allocation - v0.0.6 (2018-06-10), Roman Rubsamen <roman.rubsamen@gmail.com> */
var PortfolioAllocation=PortfolioAllocation||{};PortfolioAllocation=function(p){function st(t){if(!(this instanceof st))return new st(t);var o=this;if(t instanceof Array&&t[0]instanceof Array)return function(t){o=b(t.length,t[0].length);for(var r=0;r<o.nbRows;++r){if(!(t[r]instanceof Array))throw new Error("unsupported input type");if(t[r].length!==o.nbColumns)throw new Error("unsupported input type");for(var n=0;n<o.nbColumns;++n)o.data[r*o.nbColumns+n]=t[r][n]}return o}(t);if(t instanceof Array||"function"==typeof Float64Array&&t instanceof Float64Array)return function(t){o=b(t.length,1);for(var r=0;r<o.nbRows;++r)o.data[r*o.nbColumns]=t[r];return o}(t);if(t instanceof st)return o=st.copy(t);throw new Error("unsupported input type")}function b(t,r,n){var o;if(void 0===n)(o=Object.create(st.prototype)).nbRows=t,o.nbColumns=r,o.data="function"==typeof Float64Array?new Float64Array(o.nbRows*o.nbColumns):new Array(o.nbRows*o.nbColumns);else{if(!(n instanceof st))throw new Error("provided output must be a matrix");if(n.nbRows!==t||n.nbColumns!==r)throw new Error("provided output matrix size does not match expected matrix size: ("+n.nbRows+","+n.nbColumns+") v.s. ("+t+","+r+")");o=n}return o}function u(t){var r={getCorrelationMatrix:function(t){for(var r=b(this.nbRows,this.nbColumns,t),n=0;n<r.nbRows;++n){for(var o=Math.sqrt(this.data[n*this.nbColumns+n]),e=0;e<n;++e)r.data[n*r.nbColumns+e]=r.data[e*this.nbColumns+n];for(e=n;e<r.nbColumns;++e){var a=Math.sqrt(this.data[e*this.nbColumns+e]);r.data[n*r.nbColumns+e]=this.data[n*this.nbColumns+e]/(o*a)}}return r},getVariancesVector:function(t){return this.diagonal(t)},standardizedGeneralizedVariance:function(){var t=this.determinant();if(t<0)throw new Error("covariance matrix is not positive semi-definite");return Math.pow(t,1/this.nbRows)}};for(var n in r)t[n]=r[n]}function ut(){if(!(this instanceof ut))return new ut;this.WORD_LENGTH=32,this.WORD_LOG=5,this.words="function"==typeof Uint32Array?new Uint32Array(0):new Array(0);var n=this;this.iterator=function(){for(this.w_idx=-1,this.w=0;this.w_idx<n.words.length&&0==this.w;)++this.w_idx,this.w=n.words[this.w_idx];this.next=function(){if(this.w_idx==n.words.length)return 0;var t=this.w&-this.w,r=(this.w_idx<<n.WORD_LOG)+ut.populationCount(t-1|0);for(this.w^=t;this.w_idx<n.words.length&&0==this.w;)++this.w_idx,this.w=n.words[this.w_idx];return r}}}function N(t){this.prob="function"==typeof Float64Array?new Float64Array(t.length):new Array(t.length),this.alias="function"==typeof Uint32Array?new Uint32Array(t.length):new Array(t.length);for(var r=1/t.length,n="function"==typeof Uint32Array?new Uint32Array(t.length):new Array(t.length),o=0,e="function"==typeof Uint32Array?new Uint32Array(t.length):new Array(t.length),a=0,i=0;i<t.length;++i)t[i]>r?(e[a]=i,++a):(n[o]=i,++o);for(t=t.slice(0);0<o&&0<a;){i=n[--o];var s=e[--a];this.prob[i]=t.length*t[i],t[this.alias[i]=s]=t[s]+(t[i]-r),t[s]>r?(e[a]=s,++a):(n[o]=s,++o)}for(;0<o;)--o,this.prob[n[o]]=1;for(;0<a;)--a,this.prob[e[a]]=1;this.sample=function(){var t=Math.random()*this.prob.length,r=Math.floor(t);return t-r<=this.prob[r]?r:this.alias[r]}}function o(t,r,n){this.n=t,this.k=r,this.useArrayCopy=n,this.firstcall=!0,this.mtc=!1,this.r="function"==typeof Uint32Array?new Uint32Array(r):new Array(r),this.t=this.n,this.h=0,this.next=function(){if(!this.firstcall&&!this.mtc)return-1;if(this.firstcall){this.firstcall=!1,this.r[0]=this.n;for(var t=1;t<=this.k-1;++t)this.r[t]=0}else 1<this.t&&(this.h=0),++this.h,this.t=this.r[this.h-1],this.r[this.h-1]=0,this.r[0]=this.t-1,++this.r[this.h];return this.mtc=this.r[this.k-1]!=this.n,this.useArrayCopy?this.r.slice(0):this.r}}function y(t,r,n){this.n=t,this.k=r,this.useArrayCopy=n,this.a="function"==typeof Uint32Array?new Uint32Array(r):new Array(r),this.firstcall=!0,this.mtc=!1,this.m2=0,this.h=this.k,this.endval=this.n-this.k+1,this.next=function(){if(!this.firstcall&&!this.mtc)return-1;this.firstcall?this.firstcall=!1:(this.m2<this.n-this.h&&(this.h=0),++this.h,this.m2=this.a[this.k-this.h]);for(var t=1;t<=this.h;++t)this.a[this.k+t-this.h-1]=this.m2+t;return this.mtc=this.a[0]!=this.endval,this.useArrayCopy?this.a.slice(0):this.a}}function g(t,r,n){function d(){for(var t=Math.random();0===t;)t=Math.random();return t}this.n=t,this.k=r,this.useArrayCopy=n,this.a="function"==typeof Uint32Array?new Uint32Array(r):new Array(r),this.N,this.nn,this.idx_a,this.selected_record,this.method_a=function(){for(var t=this.N-this.nn;2<=this.nn;){for(var r=d(),n=0,o=t/this.N;r<o;)++n,--t,--this.N,o=o*t/this.N;this.selected_record+=n+1,this.a[this.idx_a++]=this.selected_record,--this.N,--this.nn}(n=Math.floor(this.N*d()))===this.N&&(n=this.N-1),this.selected_record+=n+1,this.a[this.idx_a++]=this.selected_record},this.method_d=function(){for(var t=1/this.nn,r=Math.pow(d(),t),n=1-this.nn+this.N,o=13*this.nn;1<this.nn&&o<this.N;){for(var e,a,i=1/(-1+this.nn);;){for(;e=this.N*(1-r),!((a=Math.floor(e))<n);)r=Math.pow(d(),t);var s=d(),u=Math.pow(s*this.N/n,i);if((r=u*(-e/this.N+1)*(n/(-a+n)))<=1)break;var h,f,l=1,m=-1+this.N;f=-1+this.nn>a?(h=-this.nn+this.N,-a+this.N):(h=-1-a+this.N,n);for(var w=-1+this.N;f<=w;--w)l=l*m/h,--m,--h;if(this.N/(-e+this.N)>=u*Math.pow(l,i)){r=Math.pow(d(),i);break}r=Math.pow(d(),t)}this.selected_record+=a+1,this.a[this.idx_a++]=this.selected_record,this.N=-a+(-1+this.N),--this.nn,t=i,n=-a+n,o+=-13}1<this.nn?this.method_a():((a=Math.floor(this.N*r))===this.N&&(a=this.N-1),this.selected_record+=a+1,this.a[this.idx_a++]=this.selected_record)},this.next=function(){for(var t=0;t<this.k;++t)this.a[t]=0;return this.N=this.n,this.nn=this.k,this.idx_a=0,this.selected_record=0,this.method_d(),this.useArrayCopy?this.a.slice(0):this.a}}function v(t){this.n=t,this.firstcall=!0,this.mtc=!1,this.iin="function"==typeof Uint32Array?new Uint32Array(t):new Array(t),this.ncard=0,this.next=function(){var t=[];if(!this.firstcall&&!this.mtc)return-1;if(this.firstcall){this.firstcall=!1;for(var r=0;r<=this.n-1;++r)this.iin[r]=0;this.mtc=!0}else{var n=0;if(this.ncard%2!=0)for(++n;0==this.iin[n-1];)++n;this.iin[n]=1-this.iin[n],this.ncard=this.ncard+2*this.iin[n]-1,t="function"==typeof Uint32Array?new Uint32Array(this.ncard):new Array(this.ncard);var o=0;for(r=0;r<=this.n-1;++r)1==this.iin[r]&&(t[o++]=r+1);this.mtc=this.ncard!=this.iin[this.n-1]}return t}}function x(t,r){if(t<0)throw new Error("n must be a positive integer");if(r<0)throw new Error("k must be a positive integer");if(t<r)throw new Error("k must be less than or equal to n");for(var n=1,o=1;o<=r;++o)n*=t+1-o,n/=o;return n}function C(t){for(var r=t.length,n=t[0].nbRows,o=st.zeros(n,1),e=1;e<=n;++e){for(var a=0,i=0;i<r;++i)a+=t[i].getValue(e,1);var s=a/r,u=0;for(i=0;i<r;++i)u+=t[i].getValue(e,1)-s;o.setValue(e,1,(a+u)/r)}return o}function R(a){var i=a.length,s=a[0].nbRows,u=st.zeros(s,1),t=C(a),h=.01/i;return r(function(t){for(var r=0,n=0;n<i;++n){r+=f(st.xmy(t,a[n],u).vectorNorm("two"),h)}return r},function(t){for(var r=st.zeros(s,1),n=0;n<i;++n){var o=st.xmy(t,a[n],u),e=o.vectorNorm("two");r=st.axpby(1,r,1/f(e,h),o,r)}return r},function(t){return 0},function(t,r){return t},t,{eps:1e-4,maxIter:-1,maxLine:-1})[0]}function ht(t,r){r=r||function(t,r){return t-r};for(var n=t.length,o=t[0],e=0,a=1;a<n;++a)0<r(t[a],o)&&(o=t[a],e=a);return[o,e]}function W(t,r,n){n=n||function(t,r){return t-r};var o=t.length,e="function"==typeof UInt32Array?new UInt32Array(10):new Array(10),a="function"==typeof UInt32Array?new UInt32Array(10):new Array(10),i=0,s=0,u=o-1;for(r=r-1;;)if(600<u-s&&i<10){var h=u-s+1,f=r-s+1,l=h,m=Math.log(l),w=Math.floor(.5*Math.exp(2*m/3)+.5),d=l/2<=f?1:-1,c=.5*Math.sqrt(m*w*(1-w/l))*d+.5;c=-1<c&&c<1?0:1<=c?Math.floor(c):Math.ceil(c),f==h/2&&(c=0),e[i]=s,a[i]=u,i++;var b=r-f*(w/l)+c;s<b&&(s=Math.floor(b+.5)),b+w<u&&(u=Math.floor(b+w+.5))}else{if(u<=s){if(0==i)return t[r];s=e[--i],u=a[i]}var v=t[r];for(f=s,j=u,t[r]=t[s],n(t[s]=v,t[u])<0&&(t[s]=t[u],t[u]=v);f<j;){var p=t[j];for(t[j]=t[f],t[f]=p,++f,--j;n(t[f],v)<0;)++f;for(;0<n(t[j],v);)--j}if(0==n(t[s],v)){p=t[s];t[s]=t[j],t[j]=p}else{++j;p=t[j];t[j]=t[u],t[u]=p}j<=r&&(s=j+1),r<=j&&(u=j-1)}}function A(t){var r=Math.pow(2,-52),n=(2-r)*Math.pow(2,1023),o=Math.pow(2,-1022);if(t!=t)return t;if(t===-1/0)return-n;if(t===1/0)return 1/0;if(t===+n)return 1/0;var e=t*(t<0?1-r/2:1+r);e===t&&(e=0<o*r?t+o*r:t+o),e===1/0&&(e=+n);var a=t+(e-t)/2;t<a&&a<e&&(e=a);var i=(e+t)/2;return t<i&&i<e&&(e=i),0===e?-0:e}function f(t,r){var n=0,o=Math.abs(t),e=Math.abs(r);return n=e<o?(n=r/t,o*Math.sqrt(1+n*n)):0!=r?(n=t/r,e*Math.sqrt(1+n*n)):0}function d(t,r){for(var n=new Array(t.length),o=0;o<t.length;++o)n[o]=[t[o],o];0==r?n.sort(function(t,r){return t[0]>r[0]?-1:1}):1==r&&n.sort(function(t,r){return t[0]<r[0]?-1:1});var e=new Array(t.length);for(o=e[n[0][1]]=1;o<t.length;++o)n[o][0]==n[o-1][0]?e[n[o][1]]=e[n[o-1][1]]:e[n[o][1]]=o+1;return e}function E(t,r){void 0===(r=r)&&(r=.5);for(var n=[],o=(t=new st(t)).nbRows,e=new Array(o),a=0;a<e.length;++a)e[a]=a+1;for(;0!=e.length;){if(1===e.length){var i=[e[0]];e[0]=null,n.push(i)}else{var s=t.submatrix(e,e).toRowArray(function(t,r,n){return t!=r}),u=new Array(e);for(a=0;a<e.length;++a)u[a]=M(s[a]);var h=0,f=-1,l=-1,m=0,w=-1,d=1;for(a=0;a<e.length;++a)u[a]>=l&&(h=e[a],l=u[f=a]),u[a]<=d&&(m=e[a],d=u[w=a]);if(t.getValueAt(h,m)>r){var c=h===m?[h]:[h,m];e[f]=null,e[w]=null;for(a=0;a<e.length;++a){if(null!==e[a])r<(t.getValueAt(e[a],h)+t.getValueAt(e[a],m))/2&&(c.push(e[a]),e[a]=null)}n.push(c)}else{var b=[h];e[f]=null;for(a=0;a<e.length;++a)null!==e[a]&&t.getValueAt(e[a],h)>r&&(b.push(e[a]),e[a]=null);if(n.push(b),h!==m){var v=[m];e[w]=null;for(a=0;a<e.length;++a)null!==e[a]&&t.getValueAt(e[a],m)>r&&(v.push(e[a]),e[a]=null);n.push(v)}}}var p=[];for(a=0;a<e.length;++a)null!==e[a]&&p.push(e[a]);e=p}return n}function M(t){for(var r,n=t.length,o=0,e=0;e<n;++e)o+=t[e];r=o/n;var a=0;for(e=0;e<n;++e)a+=t[e]-r;return(o+a)/n}function n(t){for(var r=t.length,n=M(t),o=0,e=0,a=0;a<r;++a){var i=t[a]-n;o+=i*i,e+=i}return(o-e*e/r)/r}function c(t){return Math.sqrt(function(t){var r=t.length;return n(t)*r/(r-1)}(t))}function V(t){var r=t,n=0,o=t,e=t*t,a=1;if(t<-8)return 0;if(8<t)return 1;for(;r!=n;)r=(n=r)+(o*=e/(a+=2));return.5+r*Math.exp(-.5*e-.9189385332046728)}function s(t){if(t<=0||1<=t){if(0==t)return-1/0;if(1==t)return 1/0;throw"The probality p must be bigger than 0 and smaller than 1"}var r,n=t-.5;if(Math.abs(n)<=.425){r=n*(((((((2509.0809287301227*(o=.180625-n*n)+33430.57558358813)*o+67265.7709270087)*o+45921.95393154987)*o+13731.69376550946)*o+1971.5909503065513)*o+133.14166789178438)*o+3.3871328727963665)/(((((((5226.495278852854*o+28729.085735721943)*o+39307.89580009271)*o+21213.794301586597)*o+5394.196021424751)*o+687.1870074920579)*o+42.31333070160091)*o+1)}else{var o;if(o=n<0?t:1-t,(o=Math.sqrt(-Math.log(o)))<=5)r=(((((((.0007745450142783414*(o-=1.6)+.022723844989269184)*o+.2417807251774506)*o+1.2704582524523684)*o+3.6478483247632045)*o+5.769497221460691)*o+4.630337846156546)*o+1.4234371107496835)/(((((((1.0507500716444169e-9*o+.0005475938084995345)*o+.015198666563616457)*o+.14810397642748008)*o+.6897673349851)*o+1.6763848301838038)*o+2.053191626637759)*o+1);else r=(((((((2.0103343992922881e-7*(o-=5)+27115555687434876e-21)*o+.0012426609473880784)*o+.026532189526576124)*o+.29656057182850487)*o+1.7848265399172913)*o+5.463784911164114)*o+6.657904643501103)/(((((((20442631033899397e-31*o+1.421511758316446e-7)*o+18463183175100548e-21)*o+.0007868691311456133)*o+.014875361290850615)*o+.1369298809227358)*o+.599832206555888)*o+1);n<0&&(r=-r)}return r}function h(t,r){for(var n=t.length,o=M(t),e=M(r),a=0,i=0,s=0,u=0;u<n;++u){var h=t[u]-o,f=r[u]-e;a+=h*f,i+=h,s+=f}return(a-i*s/n)/n}function r(r,t,n,e,o,a){function i(t){return r(t)+n(t)}function s(t,r,n){var o=st.axpby(1,r,-t,n);return[o,st.copy(e(o,t))]}void 0===a&&(a={});for(var u,h,f,l,m,w,d,c,b,v,p,y,g,x,C,R,A=a.eps||1e-4,E=a.maxIter||1e4,M=a.maxLine||100,V=a.beta||.5,z=a.alphaMin||1e-10,_=a.alphaMax||1e10,P=a.restartPeriod||1e3,I=o.nbRows,O=1e-12,N=.5,q=z,S=st.zeros(I,1),U=st.zeros(I,1),F=st.zeros(I,1),B=st.zeros(I,1),D=st.zeros(I,1),W=!0,k=0;;){if(-1!==E&&E<k)throw new Error("maximum number of iterations reached: "+E);++k%P==0&&(o=m,W=!0),!0===W&&(u=0,f=h=1,l=null,m=st.copy(o),w=st.copy(m),st.copy(w),d=st.zeros(I,1),S=st.copy(t(m),S),U=st.copy(S,U),F=st.copy(U,F),c=st.zeros(I,1),B=st.copy(m,B),D=st.copy(S,D),W=!1);for(var L=q,T=s(L,B,D),G=T[0],j=T[1],H=0;i(j)>(b=L,v=j,y=D,x=void 0,g=r(p=B),x=st.xmy(v,p),C=x.vectorNorm("two"),R=n(v),g+st.vectorDotProduct(x,y)+1/(2*b)*C*C+R+O);){if(-1!==M&&M<H)throw new Error("maximum number of line searches reached: "+M+" at iteration: "+k);++H,L*=V,f/=V,h=(1+Math.sqrt(1+4*f*u*u))/2,G=(T=s(L,B=st.axpby(1,w,(u-1)/h,d,B),D=st.axpby(1,U,(u-1)/h,c,D)))[0],j=T[1]}S=st.copy(t(m=j),S);var Y=st.xmy(m,w),K=st.xmy(S,U),X=st.vectorDotProduct(Y,Y),J=Math.max(st.vectorDotProduct(K,K),O),Q=st.vectorDotProduct(Y,K);if(Q<=O)mu_kp_0=_;else{var Z=Math.max(z,Math.min(X/Q,_)),$=Math.max(z,Math.min(Q/J,_));$/Z<=N?(mu_kp_0=$,N*=.9):(mu_kp_0=Z,N*=1.1)}l=L/mu_kp_0;var tt=(1+Math.sqrt(1+4*l*h*h))/2,rt=st.axpby(1,m,(h-1)/tt,Y),nt=st.axpby(1,S,(h-1)/tt,K),ot=st.axpby(1/L,G,-1/L,m);if(st.xpy(S,ot).vectorNorm("infinity")<=A)break;O<=st.vectorDotProduct(st.xmy(B,m),Y)&&(o=m,W=!0),q=mu_kp_0,w,w=m,d=Y,F=st.copy(U,F),U=st.copy(S,U),c=K,B=st.copy(rt,B),D=st.copy(nt,D),f=l,u=h,h=tt}return[m,i(m)]}function S(i,s,u,t,h,f,r){function n(t,r){return t instanceof Array?(t.length=r,t):t instanceof Float64Array||t instanceof Int32Array?t.subarray(0,r):void 0}function o(t){for(var r=v-t*p+y,n=new b.iterator,o=n.next();0!=o;){var e,a=o-1;t<=c[a]?e=f.data[a]:c[a]<=t&&t<=d[a]?e=(s.data[a]-t*u.data[a])/i.data[a]:d[a]<=t&&(e=h.data[a]),r+=u.data[a]*e,o=n.next()}return r}void 0===r&&(r={});var e=r.eps||1e-16,a=r.outputLagrangeMultiplier;if(!(i instanceof st&&i.isVector()))throw new Error("first input must be a vector");if(!(s instanceof st&&s.isVector()))throw new Error("second input must be a vector");if(!(u instanceof st&&u.isVector()))throw new Error("third input must be a vector");if(!(h instanceof st&&h.isVector()))throw new Error("fifth input must be a vector");if(!(f instanceof st&&f.isVector()))throw new Error("sixth input must be a vector");if(i.nbRows!==s.nbRows)throw new Error("first and second inputs number of rows do not match: "+i.nbRows+"-"+s.nbRows);if(i.nbRows!==u.nbRows)throw new Error("first and third inputs number of rows do not match: "+i.nbRows+"-"+u.nbRows);if(i.nbRows!==h.nbRows)throw new Error("first and fifth inputs number of rows do not match: "+i.nbRows+"-"+h.nbRows);if(i.nbRows!==f.nbRows)throw new Error("first and sixth inputs number of rows do not match: "+i.nbRows+"-"+f.nbRows);for(var l=u.nbRows,m=Math.abs(t),w="function"==typeof Float64Array?new Float64Array(2*l):new Array(2*l),d="function"==typeof Float64Array?new Float64Array(l):new Array(l),c="function"==typeof Float64Array?new Float64Array(l):new Array(l),b=(new ut).setRange(1,l),v=0,p=0,y=0,g=1/0,x=-1/0,C=0,R=0;C<l;++C){if(h.data[C]>f.data[C])throw new Error("infeasible problem detected");if(u.data[C]<=0)throw new Error("negative element detected in b");if(i.data[C]<=0)throw new Error("negative element detected in d");var A=(s.data[C]-h.data[C]*i.data[C])/u.data[C];d[C]=A,w[R++]=A;var E=(s.data[C]-f.data[C]*i.data[C])/u.data[C];c[C]=E,x<A&&(x=A),(w[R++]=E)<g&&(g=E)}var M=o(g),V=o(x);if(M<t||t<V)throw new Error("infeasible problem detected");var z=null;if(Math.abs(M-t)<=e*m)z=g;else if(Math.abs(M-t)<=e*m)z=x;else{for(var _=g,P=x;0!=w.length;){var I=Math.ceil(w.length/2),O=W(w,I),N=o(O);if(Math.abs(N-t)<=e*m){z=O;break}if(t<N){_=O;for(R=0,C=I;C<w.length;++C)w[R++]=w[C];w=n(w,R)}else N<t&&(P=O,w=n(w,I-1));for(var q=new b.iterator,S=q.next();0!=S;){var U=!1;if(d[C=S-1]<=_&&(y+=u.data[C]*h.data[C],U=!0),P<=c[C]&&(y+=u.data[C]*f.data[C],U=!0),c[C]<=_&&P<=d[C]){var F=u.data[C]/i.data[C];v+=s.data[C]*F,p+=u.data[C]*F,U=!0}!0===U&&b.unset(C+1),S=q.next()}}0==w.length&&(z=(v+y-t)/p)}var B=function(){for(var t=st.zeros(l,1),r=0;r<l;++r){var n;z<=c[r]?n=f.data[r]:c[r]<=z&&z<=d[r]?n=(s.data[r]-z*u.data[r])/i.data[r]:d[r]<=z&&(n=h.data[r]),t.data[r]=n}return t}(),D=.5*st.vectorDotProduct(B,st.elementwiseProduct(B,i))-st.vectorDotProduct(s,B);return!0===a?[B,D,z]:[B,D]}function z(t,r,n,o,e,i,s){void 0===s&&(s={});var u=s.eps||1e-4,h=s.maxIter||1e4;if(!(t instanceof st&&t.isSquare()))throw new Error("first input must be a square matrix");if(!(r instanceof st&&r.isVector()))throw new Error("second input must be a vector");if(!(n instanceof st&&n.isVector()))throw new Error("third input must be a vector");if(!(e instanceof st&&e.isVector()))throw new Error("fifth input must be a vector");if(!(i instanceof st&&i.isVector()))throw new Error("sixth input must be a vector");if(t.nbRows!==r.nbRows)throw new Error("first and second inputs number of rows do not match: "+t.nbRows+"-"+a.nbRows);if(t.nbRows!==n.nbRows)throw new Error("first and third inputs number of rows do not match: "+t.nbRows+"-"+n.nbRows);if(t.nbRows!==e.nbRows)throw new Error("first and fifth inputs number of rows do not match: "+t.nbRows+"-"+e.nbRows);if(t.nbRows!==i.nbRows)throw new Error("first and sixth inputs number of rows do not match: "+t.nbRows+"-"+i.nbRows);for(var f=t.nbRows,l=st.fill(f,1,function(t,r){return o/f*1/n.data[t-1]}),m=S(st.ones(f,1),l,n,o,e,i)[0],w=st.xpy(st.xy(t,m),r),d=0;;){if(-1!==h&&h<=d)throw new Error("maximum number of iterations reached: "+h);++d;for(var c=-1,b=-1/0,v=-1,p=1/0,y=0;y<f;++y)F_i=w.data[y]/n.data[y],e.data[y]<m.data[y]&&m.data[y]<i.data[y]?(F_i>b&&(b=F_i,c=y),F_i<p&&(p=F_i,v=y)):m.data[y]==e.data[y]?F_i<p&&(p=F_i,v=y):m.data[y]==i.data[y]&&F_i>b&&(b=F_i,c=y);if(b-p<=u)break;y=v;var g,x=c,C=(e.data[y]-m.data[y])*n.data[y],R=(m.data[x]-i.data[x])*n.data[x],A=R<=C?C:R,E=(i.data[y]-m.data[y])*n.data[y],M=(m.data[x]-e.data[x])*n.data[x],V=E<=M?E:M,z=p-b,_=t.data[y*t.nbColumns+y]/(n.data[y]*n.data[y])+t.data[x*t.nbColumns+x]/(n.data[x]*n.data[x])-2*t.data[y*t.nbColumns+x]/(n.data[y]*n.data[x]);0<_?V<(g=-z/_)?g=V:g<A&&(g=A):g=0<z?A:V;var P=m.data[y],I=m.data[x],O=g/n.data[y],N=-g/n.data[x];m.data[y]+=O,m.data[x]+=N,g==A&&(A==C&&(m.data[y]=e.data[y],O=m.data[y]-P),A==R&&(m.data[x]=i.data[x],N=m.data[x]-I)),g==V&&(V==E&&(m.data[y]=i.data[y],O=m.data[y]-P),V==M&&(m.data[x]=e.data[x],N=m.data[x]-I));for(var q=0;q<f;++q)w.data[q]=w.data[q]+t.data[q*t.nbColumns+y]*O+t.data[q*t.nbColumns+x]*N}return[m,.5*st.vectorDotProduct(m,st.xy(t,m))+st.vectorDotProduct(r,m)]}function m(o,t,e,r,n,a,i,s){void 0===s&&(s={});var u=s.eps||1e-8,h=s.maxIter||1e5,f=!1,l=!1,m=!1;if(null!==o&&null!==t)f=!0;else{if(null!==o&&null===t)throw new Error("equality constraints vector is missing");if(null===o&&null!==t)throw new Error("equality constraints matrix is missing")}if(null!==e&&null!==r)l=!0;else{if(null!==e&&null===r)throw new Error("inequality constraints vector is missing");if(null===e&&null!==r)throw new Error("inequality constraints matrix is missing")}if(null!==a&&null!==i)m=!0;else{if(null!==a&&null===i)throw new Error("upper bounds constraints vector is missing");if(null===a&&null!==i)throw new Error("lower bounds constraints vector is missing")}if(!(n instanceof st))throw new Error("fifth input must be a matrix");if(1!==n.nbColumns)throw new Error("fifth input is not a vector: "+n.nbColumns+"-"+n.nbRows);if(f){if(!(o instanceof st))throw new Error("first input must be a matrix");if(!(t instanceof st))throw new Error("second input must be a matrix");if(o.nbRows!==t.nbRows)throw new Error("first and second inputs number of rows do not match: "+o.nbRows+"-"+t.nbRows);if(o.nbColumns!==n.nbRows)throw new Error("first input number of columns and fifth input number of rows do not match: "+o.nbColumns+"-"+n.nbRows);if(1!==t.nbColumns)throw new Error("second input is not a vector: "+t.nbColumns+"-"+t.nbRows)}if(l){if(!(e instanceof st))throw new Error("third input must be a matrix");if(!(r instanceof st))throw new Error("third input must be a matrix");if(e.nbRows!==r.nbRows)throw new Error("third and fourth inputs number of rows do not match: "+e.nbRows+"-"+r.nbRows);if(e.nbColumns!==n.nbRows)throw new Error("third input number of columns and fifth input number of rows do not match: "+e.nbColumns+"-"+n.nbRows);if(1!==r.nbColumns)throw new Error("fourth input is not a vector: "+r.nbColumns+"-"+r.nbRows)}if(m){if(null!==a.nbRows){if(!(a instanceof st))throw new Error("sixth input must be a matrix");if(a.nbRows!==n.nbRows)throw new Error("sixth input number of rows and fifth input number of rows do not match: "+a.nbRows+"-"+n.nbRows)}if(null!==i.nbRows){if(!(i instanceof st))throw new Error("seventh input must be a matrix");if(i.nbRows!==n.nbRows)throw new Error("seventh input number of rows and fifth input number of rows do not match: "+i.nbRows+"-"+n.nbRows)}}var w=0,d=null,c=null,b=null;f&&(w=o.nbRows,d=st.zeros(w,1),c=st.zeros(w,1),b=st.zeros(w,1));var v=0,p=null,y=null,g=null;l&&(v=e.nbRows,p=st.zeros(v,1),y=st.zeros(v,1),g=st.zeros(v,1));var x=n.nbRows,C=st.ones(x,1),R=st.ones(x,1),A=st.ones(x,1),E=st.zeros(x,1),M=st.zeros(x,1),V=st.zeros(x,1),z=null;f&&(z=st.zeros(w,1));var _=null;l&&(_=st.zeros(v,1));var P=st.fill(x,1,function(t,r){var n=0;f&&(n+=o.vectorNorm("one","column",t));l&&(n+=e.vectorNorm("one","column",t));return 0==n&&(n=1),.9995/n}),I=null;f&&(I=st.fill(w,1,function(t,r){var n=o.vectorNorm("one","row",t);return 0==n&&(n=1),.9995/n}));var O=null;l&&(O=st.fill(v,1,function(t,r){var n=e.vectorNorm("one","row",t);return 0==n&&(n=1),.9995/n}));for(var N=0;;){if(-1!==h&&h<=N)throw new Error("maximum number of iterations reached: "+h);if(++N,f&&l?R=st.xpy(st.xpy(st.txy(o,d,M),st.txy(e,p,V),M),n,R):f?R=st.xpy(st.txy(o,d,M),n,R):l&&(R=st.xpy(st.txy(e,p,M),n,R)),R=st.xmy(C,st.elementwiseProduct(R,P,M),R),m)for(var q=1;q<=x;++q)R.data[q-1]<a.data[q-1]?R.data[q-1]=a.data[q-1]:R.data[q-1]>i.data[q-1]&&(R.data[q-1]=i.data[q-1]);else for(q=1;q<=x;++q)R.data[q-1]<0&&(R.data[q-1]=0);if(A=st.axpby(2,R,-1,C,A),f&&(c=st.xpy(d,st.elementwiseProduct(st.xmy(st.xy(o,A,z),t,z),I,z),c)),l){y=st.xpy(p,st.elementwiseProduct(st.xmy(st.xy(e,A,_),r,_),O,_),y);for(q=1;q<=v;++q)y.data[q-1]<0&&(y.data[q-1]=0)}var S=(E=st.xmy(R,C,E)).vectorNorm("infinity"),U=R.vectorNorm("infinity"),F=0,B=0;f&&(F=(b=st.xmy(c,d,b)).vectorNorm("infinity"),B=c.vectorNorm("infinity"));var D=0,W=0;if(l&&(D=(g=st.xmy(y,p,g)).vectorNorm("infinity"),W=y.vectorNorm("infinity")),S<=u*U&&F<=u*B&&D<=u*W)break;C=st.copy(R,C),f&&(d=st.copy(c,d)),l&&(p=st.copy(y,p))}return[R,st.vectorDotProduct(n,R)]}function l(t){var r=t.length,n=st.zeros(r,1),o=st.ones(r,1);return S(o,new st(t),o,1,n,o)[0].toArray()}function _(t,r,n){this.n=t,this.k=r,this.useArrayCopy=n,this.x="function"==typeof Float64Array?new Float64Array(t):new Array(t),this.compositionIterator=new o(r,t,!1),this.sample=function(){var t=this.compositionIterator.next();if(-1==t)return-1;for(var r=t.length,n=0;n<r;++n)this.x[n]=t[n]/this.k;return this.useArrayCopy?this.x.slice(0):this.x}}function w(h,t,r,n){if(this.n=h,this.x="function"==typeof Float64Array?new Float64Array(h):new Array(h),this.u="function"==typeof Float64Array?new Float64Array(h-1):new Array(h-1),this.randomGenerator=function(t){for(var r=0;r<this.n;++r)t[r]=Math.random()},n){if("function"!=typeof n)throw new Error("the random number generator must be a function");this.randomGenerator=n}if(t&&(this.lowerBounds=t,!r)){this.upperBounds="function"==typeof Float64Array?new Float64Array(h):new Array(h);for(var o=0;o<this.n;++o)this.upperBounds[o]=1}if(r&&(this.upperBounds=r,!t)){this.lowerBounds="function"==typeof Float64Array?new Float64Array(h):new Array(h);for(o=0;o<this.n;++o)this.lowerBounds[o]=0}if(this.lowerBounds||this.upperBounds){var e=0,a=0;for(o=0;o<this.n;++o){var i=this.lowerBounds[o];if((f=this.upperBounds[o])<i)throw new Error("infeasible problem detected: lower bound strictly greater than upper bound");if(i<0)throw new Error("incorrect problem detected: lower bound strictly lower than 0");if(1<f)throw new Error("incorrect problem detected: upper bound strictly greater than 1");e+=i,a+=f}if(this.sumLowerBounds=e,this.sumUpperBounds=a,1<this.sumLowerBounds||this.sumUpperBounds<1)throw new Error("infeasible problem detected: the restricted simplex is empty");if(1==this.sumLowerBounds||1==this.sumUpperBounds);else{var s=0,u=0;for(o=0;o<this.n;++o){i=this.lowerBounds[o];var f=this.upperBounds[o],l=Math.max(i,f+1-this.sumUpperBounds),m=Math.min(f,i+1-this.sumLowerBounds);s+=this.lowerBounds[o]=l,u+=this.upperBounds[o]=m}this.sumLowerBounds=s,this.sumUpperBounds=u,this.upperStarBounds="function"==typeof Float64Array?new Float64Array(h):new Array(h),this.runningSumUpperStarBounds="function"==typeof Float64Array?new Float64Array(h):new Array(h);var w=0;for(o=0;o<this.n;++o)this.upperStarBounds[o]=(this.upperBounds[o]-this.lowerBounds[o])/(1-this.sumLowerBounds),w+=this.upperStarBounds[o],this.runningSumUpperStarBounds[o]=w}}this.sample_no_bounds=function(){for(var t=0,r=0;r<this.n;++r){var n=1-Math.random(),o=Math.log(n);t+=this.x[r]=o}for(r=0;r<this.n;++r)this.x[r]=this.x[r]/t;return this.x.slice(0)},this.sample_binding_bounds=function(){var t=null;if(1==this.sumLowerBounds)t=this.lowerBounds;else{if(1!=this.sumUpperBounds)throw new Error("internal error");t=this.upperBounds}for(var r=0;r<this.n;++r)this.x[r]=t[r];return this.x.slice(0)},this.sample_with_bounds=function(){this.randomGenerator(this.u);for(var t=this.u,r=1,n=h;2<=n;--n){if(Math.abs(r)<=1e-14){for(var o=n;1<=o;--o)this.x[o-1]=0;break}var e=t[n-2],a=Math.max(0,1-this.runningSumUpperStarBounds[n-2]/r),i=Math.min(1,this.upperStarBounds[n-1]/r),s=r*(1-Math.pow(e*Math.pow(1-i,n-1)+(1-e)*Math.pow(1-a,n-1),1/(n-1)));r-=this.x[n-1]=s}1==n&&(this.x[0]=r);for(var u=0;u<this.n;++u)this.x[u]=(1-this.sumLowerBounds)*this.x[u]+this.lowerBounds[u];return this.x.slice(0)},this.lowerBounds||this.upperBounds?1==this.sumLowerBounds||1==this.sumUpperBounds?this.sample=this.sample_binding_bounds:this.sample=this.sample_with_bounds:this.sample=this.sample_no_bounds}function e(t,r){for(var n=r,o=new Array(t.length),e=0;e<t.length;++e){var a=r*t[e],i=Math.floor(a),s=a-i;n-=i,o[e]=[i,s,e]}o.sort(function(t,r){return r[1]<t[1]?-1:r[1]>t[1]?1:r[0]-t[0]});var u=new Array(t.length);for(e=0;e<n;++e){u[o[e][2]]=(o[e][0]+1)/r}for(e=n;e<o.length;++e){u[o[e][2]]=o[e][0]/r}return u}function i(t,r,n,o,e){var a=null,i=null;if(o&&(a=o,!e)){i="function"==typeof Float64Array?new Float64Array(r):new Array(r);for(var s=0;s<r;++s)i[s]=1}if(e&&(i=e,!o)){a="function"==typeof Float64Array?new Float64Array(r):new Array(r);for(s=0;s<r;++s)a[s]=0}if(a||i){var u=0,h=0;for(s=0;s<r;++s){var f=a[s],l=i[s];if(l<f)throw new Error("infeasible problem detected: lower bound strictly greater than upper bound");if(f<0)throw new Error("incorrect problem detected: lower bound strictly lower than 0");if(1<l)throw new Error("incorrect problem detected: upper bound strictly greater than 1");u+=f,h+=l}if(1<u||h<1)throw new Error("infeasible problem detected: the restricted simplex is empty")}for(var m=Number.POSITIVE_INFINITY,w=[],d=new _(r,n,!1),c=d.sample();-1!==c;){var b=!0;if(a)for(s=0;s<r;++s)if(a[s]>c[s]){b=!1;break}if(i)for(s=0;s<r;++s)if(c[s]>i[s]){b=!1;break}if(b){var v=t(c);v<m?(m=v,w=[c.slice(0)]):v==m&&w.push(c.slice(0)),c=d.sample()}else c=d.sample()}return w}function P(t,r,n){function w(t,r){return st.vectorDotProduct(t,r)}var o=function(t,r,n){var o=1e-8,e=n.length-1,a=0,i=n[e][0],s=n[a][0],u=w(r,i),h=w(r,s);if(o<t-h||t-u<-o)return[];if(Math.abs(t-u)<=o)return[[e,i,u]];if(Math.abs(t-h)<=o)return[[a,s,h]];for(;e-a!=1;){var f=Math.floor(a+(e-a)/2),l=n[f][0],m=w(r,l);if(o<m-t)a=f,h=m,s=l;else{if(!(m-t<-o))return[[f,l,m]];e=f,u=m,i=l}}return[[e,i,u],[a,s,h]]}(r,t,n);if(0==o.length)return[];if(1==o.length){var e=o[0][0];return[o[0][1],e]}e=o[0][0];var a=o[0][1],i=o[0][2],s=o[1][0],u=o[1][1],h=o[1][2],f=(h-r)/(h-i);return[st.fill(a.nbRows,1,function(t,r){return f*a.getValue(t,1)+(1-f)*u.getValue(t,1)}),e,s]}function I(t,r,n){function w(t,r){return Math.sqrt(st.vectorDotProduct(st.xy(t,r),r))}var o=function(t,r,n){var o=1e-8,e=n.length-1,a=0,i=n[e][0],s=n[a][0],u=w(r,i),h=w(r,s);if(o<t-h||t-u<-o)return[];if(Math.abs(t-u)<=o)return[[e,i,u]];if(Math.abs(t-h)<=o)return[[a,s,h]];for(;e-a!=1;){var f=Math.floor(a+(e-a)/2),l=n[f][0],m=w(r,l);if(o<m-t)a=f,h=m,s=l;else{if(!(m-t<-o))return[[f,l,m]];e=f,u=m,i=l}}return[[e,i,u],[a,s,h]]}(r,t,n);if(0==o.length)return[];if(1==o.length){var e=o[0][0];return[o[0][1],e]}e=o[0][0];var a=o[0][1],i=o[0][2],s=i*i,u=o[1][0],h=o[1][1],f=o[1][2],l=f*f,m=st.vectorDotProduct(st.xy(t,a),h),d=s+l-2*m,c=l-r*r,b=-2*(l-m)/2,v=0<=b?1:-1,p=b*b-d*c;if(p<0)throw new Error("internal error, the covariance matrix might not be semi-definite positive");var y,g=-(b+v*Math.sqrt(p)),x=g/d,C=c/g;if(0<x&&x<1)y=x;else{if(!(0<C&&C<1))throw new Error("internal error, the covariance matrix might not be semi-definite positive");y=C}return[st.fill(a.nbRows,1,function(t,r){return y*a.getValue(t,1)+(1-y)*h.getValue(t,1)}),e,u]}function O(t,n,r){var c=1e-8;void 0===r&&(r={constraints:{}}),void 0===r.constraints&&(r.constraints={});var o=r.maxIter||1e3,e=r.constraints.minWeights,a=r.constraints.maxWeights,b=n.nbColumns,i=st.ones(1,b),s=i.nbRows,u=st.ones(1,1),h=e?new st(e):st.zeros(b,1),f=a?new st(a):st.ones(b,1),l=[],m=null,v=new function(t,r){this.STATUS_UNDEF=-1,this.STATUS_IN=0,this.STATUS_LOW=1,this.STATUS_UP=2,this.nbAssets=t,this.nbEqualityConstraints=r,this.varIn=new ut,this.varIn.resize(t+r),this.varOut=new ut,this.varOut.resize(t+r),this.varLow=new ut,this.varLow.resize(t+r),this.varUp=new ut,this.varUp.resize(t+r),this.setIn=function(t){this.varIn.set(t),this.varOut.unset(t),this.varLow.unset(t),this.varUp.unset(t)},this.setOnLowerBound=function(t){this.varLow.set(t),this.varOut.set(t),this.varIn.unset(t),this.varUp.unset(t)},this.setOnUpperBound=function(t){this.varUp.set(t),this.varOut.set(t),this.varIn.unset(t),this.varLow.unset(t)},this.setLambdasIn=function(){for(var t=this.nbAssets+1;t<=this.nbAssets+this.nbEqualityConstraints;++t)this.varIn.set(t),this.varOut.unset(t),this.varLow.unset(t),this.varUp.unset(t)},this.setAssetsOnLowerBounds=function(){for(var t=1;t<=this.nbAssets;++t)this.varLow.set(t),this.varOut.set(t),this.varIn.unset(t),this.varUp.unset(t)},this.isAsset=function(t){return 1<=t&&t<=this.nbAssets},this.isLambda=function(t){return t>=this.nbAssets+1&&t<=this.nbAssets+this.nbEqualityConstraints},this.isIn=function(t){return this.varIn.get(t)},this.isOnLowerBound=function(t){return this.varLow.get(t)},this.isOnUpperBound=function(t){return this.varUp.get(t)},this.isOut=function(t){return this.varOut.get(t)},this.getInIndexes=function(){return this.varIn.toArray()},this.getOutIndexes=function(){return this.varOut.toArray()}}(b,s);m=function(n,t,r){for(var o=1;o<=b;++o){var e=t.getValue(o,1);if(r.getValue(o,1)<e)throw new Error("infeasible problem detected")}var a=t.sum(),i=r.sum();if(1<a||i<1)throw new Error("infeasible problem detected");for(var s="function"==typeof Uint32Array?new Uint32Array(b):new Array(b),u=0;u<b;++u)s[u]=u+1;for(s.sort(function(t,r){return n.getValue(r,1)-n.getValue(t,1)}),o=1;o<b;++o)if(n.getValue(s[o],1)==n.getValue(s[o-1],1))throw new Error("unsupported problem detected");var h=new st(t);v.setAssetsOnLowerBounds();var f=1-h.sum(),l=-1;for(o=0;o<b&&!(Math.abs(f)<=c);++o){l=s[o];var m=h.getValue(l,1),w=Math.min(r.getValue(l,1)-m,f),d=m+w;d>=r.getValue(l,1)?(h.setValue(l,1,r.getValue(l,1)),v.setOnUpperBound(l)):(h.setValue(l,1,d),v.setIn(l)),f-=w}return-1==l||o==b||v.isIn(l)||(v.setIn(l),r.setValue(l,1,r.getValue(l,1)+2e-8)),h}(t,h,f);var w=st.ones(1,1);if(Math.abs(1-h.sum())<=c||Math.abs(1-f.sum())<=c)return l.push([m,0]),l;for(var d=v.getInIndexes(),p=v.getOutIndexes(),y=st.zeros(b+s,1),g=st.zeros(b+s,1),x=1;x<=p.length;++x){var C=p[x-1];g.setValue(C,1,m.getValue(C,1))}for(var R=st.zeros(b+s,1),A=st.fill(b+s,b+s,function(t,r){return t<=b&&r<=b?n.data[(t-1)*n.nbColumns+(r-1)]:b+1<=t&&r<=b?i.data[(t-b-1)*i.nbColumns+(r-1)]:t<=b&&b+1<=r?i.data[(r-b-1)*i.nbColumns+(t-1)]:0}),E=st.zeros(b+s,b+s),M=st.atxy(-1,w,st.xy(n.submatrix(d,d),w)),V=1;V<=d.length;++V)for(var z=1;z<=d.length;++z){var _=d[V-1],P=w.getValue(V,z);E.setValue(b+z,_,P),E.setValue(_,b+z,P),E.setValue(b+V,b+z,M.getValue(V,z))}v.setLambdasIn();var I=st.zeros(b+s,1);for(x=1;x<=d.length;++x){var O=d[x-1],N=0;for(V=1;V<=p.length;++V){var q=p[V-1];N-=A.getValue(O,q)*m.getValue(q,1)}I.setValue(O,1,N)}for(x=b+1;x<=b+s;++x){for(O=x,N=u.getValue(O-b,1),V=1;V<=p.length;++V){q=p[V-1];N-=A.getValue(O,q)*m.getValue(q,1)}I.setValue(O,1,N)}for(var S=0,U=0,F=-1,B=0,D=v.STATUS_UNDEF,W=-1,k=0;;){if(-1!==o&&o<=S)throw new Error("maximum number of iterations reached: "+o);if(2<=++S)if(k<=B){g.setValue(F,1,m.getValue(F,1)),R.setValue(F,1,0),D==v.STATUS_LOW?v.setOnLowerBound(F):v.setOnUpperBound(F);var L=v.getInIndexes(),T=E.getValue(F,F);Math.abs(T)<=c&&(T=c);for(x=1;x<=L.length;++x)for(O=L[x-1],V=1;V<=L.length;++V){var G=L[V-1];E.setValue(O,G,E.getValue(O,G)-E.getValue(O,F)*E.getValue(F,G)/T)}for(x=1;x<=L.length;++x){O=L[x-1];I.setValue(O,1,I.getValue(O,1)-A.getValue(O,F)*m.getValue(F,1))}}else{for(L=v.getInIndexes(),x=1;x<=L.length;++x){O=L[x-1];var j=0;for(V=1;V<=L.length;++V){G=L[V-1];j+=E.getValue(O,G)*A.getValue(G,W)}y.setValue(O,1,j)}var H=A.getValue(W,W);for(x=1;x<=L.length;++x){O=L[x-1];H-=A.getValue(W,O)*y.getValue(O,1)}Math.abs(H)<=c&&(H=c);for(x=1;x<=L.length;++x){for(O=L[x-1],V=1;V<=L.length;++V){G=L[V-1];E.setValue(O,G,E.getValue(O,G)+y.getValue(O,1)*y.getValue(G,1)/H)}E.setValue(O,W,-y.getValue(O,1)/H),E.setValue(W,O,-y.getValue(O,1)/H)}E.setValue(W,W,1/H);for(x=1;x<=L.length;++x){O=L[x-1];I.setValue(O,1,I.getValue(O,1)+A.getValue(O,W)*m.getValue(W,1))}v.setIn(W);for(p=v.getOutIndexes(),N=0,x=1;x<=p.length;++x){C=p[x-1];N-=A.getValue(W,C)*m.getValue(C,1)}I.setValue(W,1,N)}L=v.getInIndexes(),p=v.getOutIndexes();F=-1,B=0,D=v.STATUS_UNDEF;for(x=1;x<=L.length;++x){O=L[x-1];var Y=0,K=0;for(V=1;V<=L.length;++V){G=L[V-1];var X=E.getValue(O,G);Y+=X*I.getValue(G,1),G<=b&&(K+=X*t.getValue(G,1))}if(g.setValue(O,1,Y),R.setValue(O,1,K),v.isAsset(O))if(c<K)B<=(J=(h.getValue(O,1)-Y)/K)&&(F=O,B=J,D=v.STATUS_LOW);else if(K<-c){var J;B<=(J=(f.getValue(O,1)-Y)/K)&&(F=O,B=J,D=v.STATUS_UP)}}W=-1,k=0;for(x=1;x<=p.length;++x){C=p[x-1];var Q,Z=0,$=-t.getValue(C,1);for(V=1;V<=b+s;++V){var tt=A.getValue(C,V);Z+=tt*g.getValue(V,1),$+=tt*R.getValue(V,1)}if(v.isOnLowerBound(C)){if(c<$)k<=(Q=-Z/$)&&(W=C,k=Q)}else if($<-c)k<=(Q=-Z/$)&&(W=C,k=Q)}U=ht([B,k,0])[0];for(x=1;x<=L.length;++x){O=L[x-1];v.isAsset(O)&&m.setValue(O,1,g.getValue(O,1)+U*R.getValue(O,1))}if(l.push([new st(m),U]),U<c)break}var rt=new Array(l.length),nt=0,ot=l[nt][0],et=l[nt][1];rt[nt]=[ot,et];for(x=1;x<l.length;++x){var at=l[x][0],it=l[x][1];st.areEqual(at,ot,c)||++nt,rt[nt]=[at,it],ot=at,et=it}return rt.length=nt+1,rt}return(p.Matrix=st).prototype={constructor:st,toString:function(){for(var t=0,r=0;r<this.nbRows;++r)for(var n=0;n<this.nbColumns;++n){var o=String(this.data[r*this.nbColumns+n]).length;t<o&&(t=o)}var e=[];for(r=0;r<this.nbRows;++r){e.push("[ ");for(n=0;n<this.nbColumns;++n){var a=String(this.data[r*this.nbColumns+n]);e.push(new Array(t-a.length+1).join(" ")+a+" ")}e.push("]\n")}return e.join("")},toRowArray:function(t){t=t||function(t,r,n){return!0};for(var r=new Array(this.nbRows),n=0;n<this.nbRows;++n){r[n]=new Array(this.nbColumns);for(var o=0,e=0;e<this.nbColumns;++e){var a=this.data[n*this.nbColumns+e];t(n+1,e+1,a)&&(r[n][o++]=a)}r[n].length=o}return r},toArray:function(t){t=t||function(t,r,n){return!0};for(var r=new Array(this.nbRows*this.nbColumns),n=0,o=0;o<this.nbRows;++o)for(var e=0;e<this.nbColumns;++e){var a=this.data[o*this.nbColumns+e];t(o+1,e+1,a)&&(r[n++]=a)}return r.length=n,r},setValueAt:function(t,r,n){if(t<1||r<1||t>this.nbRows||r>this.nbColumns)throw new Error("index out of bounds when setting matrix value, ("+t+","+r+") in size ("+this.nbRows+","+this.nbColumns+")");return this.data[(t-1)*this.nbColumns+(r-1)]=n,this},setValue:function(t,r,n){return this.data[(t-1)*this.nbColumns+(r-1)]=n,this},getValueAt:function(t,r){if(t<1||r<1||t>this.nbRows||r>this.nbColumns)throw new Error("index out of bounds when getting matrix value, ("+t+","+r+") in size ("+this.nbRows+","+this.nbColumns+")");return this.data[(t-1)*this.nbColumns+(r-1)]},getValue:function(t,r){return this.data[(t-1)*this.nbColumns+(r-1)]},isSquare:function(){return this.nbRows===this.nbColumns},isVector:function(){return 1===this.nbColumns},isNonNegative:function(){for(var t=0;t<this.nbRows;++t)for(var r=0;r<this.nbColumns;++r)if(this.data[t*this.nbColumns+r]<0)return!1;return!0},isPositive:function(){for(var t=0;t<this.nbRows;++t)for(var r=0;r<this.nbColumns;++r)if(this.data[t*this.nbColumns+r]<=0)return!1;return!0},isNonPositive:function(){for(var t=0;t<this.nbRows;++t)for(var r=0;r<this.nbColumns;++r)if(0<this.data[t*this.nbColumns+r])return!1;return!0},isNegative:function(){for(var t=0;t<this.nbRows;++t)for(var r=0;r<this.nbColumns;++r)if(0<=this.data[t*this.nbColumns+r])return!1;return!0},sum:function(){for(var t=0,r=0;r<this.data.length;++r)t+=this.data[r];return t},min:function(){for(var t=Number.POSITIVE_INFINITY,r=0;r<this.data.length;++r)this.data[r]<t&&(t=this.data[r]);return t},max:function(){for(var t=Number.NEGATIVE_INFINITY,r=0;r<this.data.length;++r)this.data[r]>t&&(t=this.data[r]);return t},normalize:function(t){var r=b(this.nbRows,this.nbColumns,t),n=this.sum();if(0===n)throw new Error("sum of coefficients of matrix is null");for(var o=0;o<this.data.length;++o)r.data[o]=this.data[o]/n;return r},diagonal:function(t){if(!this.isSquare())throw new Error("matrix is not square: ("+this.nbRows+","+this.nbColumns+")");for(var r=b(this.nbRows,1,t),n=0;n<this.nbRows;++n)r.data[n]=this.data[n*(this.nbColumns+1)];return r},row:function(t,r){if(t<1||t>this.nbRows)throw new Error("index out of bounds when getting matrix row, ("+t+") in size ("+this.nbRows+","+this.nbColumns+")");for(var n=b(this.nbColumns,1,r),o=0;o<this.nbColumns;++o)n.data[o]=this.data[(t-1)*this.nbColumns+o];return n},elemMap:function(t,r){for(var n=b(this.nbRows,this.nbColumns,r),o=0;o<n.nbRows;++o)for(var e=0;e<n.nbColumns;++e)n.data[o*n.nbColumns+e]=t(o+1,e+1,this.data[o*this.nbColumns+e]);return n},submatrix:function(t,r,n){if(!(t instanceof Array||t instanceof Uint32Array)||0==t.length)throw new Error("first parameter must be a non empty array");if(!(r instanceof Array||r instanceof Uint32Array)||0==r.length)throw new Error("second parameter must be a non empty array");for(var o=1;o<t.length;++o)if(t[o-1]>=t[o])throw new Error("first parameter must be a sorted array");for(var e=1;e<r.length;++e)if(r[e-1]>=t[e])throw new Error("second parameter must be a sorted array");var a=b(t.length,r.length,n);for(o=0;o<a.nbRows;++o){var i=t[o]-1;for(e=0;e<a.nbColumns;++e){var s=r[e]-1;a.data[o*a.nbColumns+e]=this.data[i*this.nbColumns+s]}}return a},transpose:function(t){for(var r=b(this.nbColumns,this.nbRows,t),n=0;n<r.nbRows;++n)for(var o=0;o<r.nbColumns;++o)r.data[n*r.nbColumns+o]=this.data[o*this.nbColumns+n];return r},determinant:function(){if(!this.isSquare())throw new Error("matrix is not square: ("+this.nbRows+","+this.nbColumns+")");for(var t=st.qrDecomposition(this,{qLess:!0}),r=1,n=0;n<t.data.length;n+=t.nbColumns+1)r*=t.data[n];return r},matrixNorm:function(t){if("one"==t){for(var r=0,n=0;n<this.nbColumns;++n){for(var o=0,e=0;e<this.nbRows;++e)o+=Math.abs(this.data[e*this.nbColumns+n]);r=Math.max(r,o)}return r}if("infinity"==t){var a=0;for(e=0;e<this.nbRows;++e){var i=0;for(n=0;n<this.nbColumns;++n)i+=Math.abs(this.data[e*this.nbColumns+n]);a=Math.max(a,i)}return a}if("frobenius"==t)return this.vectorNorm("two");throw new Error("unsupported matrix norm: "+t)},vectorNorm:function(t,r,n){var o,e,a,i;if(void 0===r||"matrix"==r)o=0,e=this.nbRows,a=0,i=this.nbColumns;else if("row"==r){if(void 0===n)throw new Error("undefined row index");if(n<1||n>this.nbRows)throw new Error("row index out of bounds: "+n);o=n-1,e=n,a=0,i=this.nbColumns}else if("column"==r){if(void 0===n)throw new Error("undefined row index");if(n<1||n>this.nbColumns)throw new Error("column index out of bounds: "+n);o=0,e=this.nbRows,a=n-1,i=n}else if(void 0!==r)throw new Error("unsupported matrix subset: "+r);if("one"==t){for(var s=0,u=o*this.nbColumns,h=o;h<e;++h){for(var f=u+a,l=a;l<i;++l)s+=Math.abs(this.data[f]),f++;u+=this.nbColumns}return s}if("two"==t){var m=0,w=1;for(u=o*this.nbColumns,h=o;h<e;++h){for(f=u+a,l=a;l<i;++l){var d=this.data[f],c=Math.abs(d);0!=c&&(m<c?(w=1+w*(m/d)*(m/d),m=c):w+=d/m*(d/m)),f++}u+=this.nbColumns}return m*Math.sqrt(w)}if("infinity"!=t)throw new Error("unsupported vector norm: "+t);var b=0;for(u=o*this.nbColumns,h=o;h<e;++h){for(f=u+a,l=a;l<i;++l)b=Math.max(b,Math.abs(this.data[f])),f++;u+=this.nbColumns}return b}},st.areEqual=function(t,r,n){if(!(t instanceof st))throw new Error("a must be a matrix");if(!(r instanceof st))throw new Error("b must be a matrix");if(t.nbRows!==r.nbRows)return!1;if(t.nbColumns!==r.nbColumns)return!1;for(var o=t.nbRows*t.nbColumns,e=n||0,a=0;a<o;++a)if(Math.abs(t.data[a]-r.data[a])>e)return!1;return!0},st.xpy=function(t,r,n){if(!(t instanceof st))throw new Error("first input must be a matrix");if(!(r instanceof st))throw new Error("second input must be a matrix");if(t.nbColumns!==r.nbColumns||t.nbRows!==r.nbRows)throw new Error("input matrices sizes do not match: ("+t.nbRows+","+t.nbColumns+") - ("+r.nbRows+","+r.nbColumns+")");for(var o=b(t.nbRows,t.nbColumns,n),e=t.nbRows*t.nbColumns,a=0;a<e;++a)o.data[a]=t.data[a]+r.data[a];return o},st.xmy=function(t,r,n){if(!(t instanceof st))throw new Error("first input must be a matrix");if(!(r instanceof st))throw new Error("second input must be a matrix");if(t.nbColumns!==r.nbColumns||t.nbRows!==r.nbRows)throw new Error("input matrices sizes do not match: ("+t.nbRows+","+t.nbColumns+") - ("+r.nbRows+","+r.nbColumns+")");for(var o=b(t.nbRows,t.nbColumns,n),e=t.nbRows*t.nbColumns,a=0;a<e;++a)o.data[a]=t.data[a]-r.data[a];return o},st.axpby=function(t,r,n,o,e){if(!(r instanceof st))throw new Error("first input must be a matrix");if(!(o instanceof st))throw new Error("second input must be a matrix");if(r.nbColumns!==o.nbColumns||r.nbRows!==o.nbRows)throw new Error("input matrices sizes do not match: ("+r.nbRows+","+r.nbColumns+") - ("+o.nbRows+","+o.nbColumns+")");for(var a=b(r.nbRows,r.nbColumns,e),i=r.nbRows*r.nbColumns,s=0;s<i;++s)a.data[s]=t*r.data[s]+n*o.data[s];return a},st.copy=function(t,r){if(!(t instanceof st))throw new Error("first input must be a matrix");for(var n=b(t.nbRows,t.nbColumns,r),o=t.nbRows*t.nbColumns,e=0;e<o;++e)n.data[e]=t.data[e];return n},st.elementwiseProduct=function(t,r,n){if(!(t instanceof st))throw new Error("first input must be a matrix");if(!(r instanceof st))throw new Error("second input must be a matrix");if(!(t.nbRows===r.nbRows&&t.nbColumns===r.nbColumns||r.nbRows===t.nbRows&&1===r.nbColumns||1===r.nbRows&&r.nbColumns===t.nbColumns))throw new Error("input matrices sizes do not match: ("+t.nbRows+","+t.nbColumns+") - ("+r.nbRows+","+r.nbColumns+")");var o=b(t.nbRows,t.nbColumns,n),e=t.nbRows,a=t.nbColumns;if(t.nbRows===r.nbRows&&t.nbColumns===r.nbColumns)for(var i=e*a,s=0;s<i;++s)o.data[s]=t.data[s]*r.data[s];else if(r.nbRows===t.nbRows&&1===r.nbColumns)for(var u=0,h=0;h<e;++h)for(var f=r.data[h],l=0;l<a;++l)o.data[u]=t.data[u]*f,u++;else if(1===r.nbRows&&r.nbColumns===t.nbColumns)for(u=0,h=0;h<e;++h)for(l=0;l<a;++l)o.data[u]=t.data[u]*r.data[l],u++;return o},st.xy=function(t,r,n){if(!(t instanceof st))throw new Error("first input must be a matrix");if(!(r instanceof st))throw new Error("second input must be a matrix");if(t.nbColumns!==r.nbRows)throw new Error("matrices sizes do not match: ("+t.nbRows+","+r.nbColumns+") - ("+r.nbRows+","+r.nbColumns+")");for(var o=b(t.nbRows,r.nbColumns,n),e=t.nbRows,a=t.nbColumns,i=r.nbColumns,s=0,u=0,h=0;h<e;++h){for(var f=u,l=0;l<i;++l)o.data[f]=0,f++;for(var m=0,w=0;w<a;++w){var d=t.data[s];f=u;for(l=0;l<i;++l)o.data[f]+=d*r.data[m],m++,f++;s++}u+=i}return o},st.txy=function(t,r,n){if(!(t instanceof st))throw new Error("second input must be a matrix");if(!(r instanceof st))throw new Error("third input must be a matrix");if(t.nbRows!==r.nbRows)throw new Error("matrices sizes do not match: ("+t.nbRows+","+r.nbColumns+") - ("+r.nbRows+","+r.nbColumns+")");for(var o=b(t.nbColumns,r.nbColumns,n),e=t.nbColumns,a=t.nbRows,i=r.nbColumns,s=0,u=0,h=0,f=0;f<e;++f){for(var l=t.data[s],m=d,w=0;w<i;++w)o.data[u]=l*r.data[w],u++;s++}var d=i;for(h=1;h<a;++h){for(f=u=0;f<e;++f){for(l=t.data[s],m=d,w=0;w<i;++w)o.data[u]+=l*r.data[m],u++,m++;s++}d+=i}return o},st.axy=function(t,r,n,o){if(!(r instanceof st))throw new Error("second input must be a matrix");if(!(n instanceof st))throw new Error("third input must be a matrix");if(r.nbColumns!==n.nbRows)throw new Error("matrices sizes do not match: ("+r.nbRows+","+n.nbColumns+") - ("+n.nbRows+","+n.nbColumns+")");for(var e=b(r.nbRows,n.nbColumns,o),a=r.nbRows,i=r.nbColumns,s=n.nbColumns,u=0,h=0,f=0;f<a;++f){for(var l=h,m=0;m<s;++m)e.data[l]=0,l++;for(var w=0,d=0;d<i;++d){var c=t*r.data[u];l=h;for(m=0;m<s;++m)e.data[l]+=c*n.data[w],w++,l++;u++}h+=s}return e},st.ax=function(t,r,n){if(!(r instanceof st))throw new Error("second input must be a matrix");for(var o=b(r.nbRows,r.nbColumns,n),e=r.nbRows,a=r.nbColumns,i=1;i<=e;++i)for(var s=1;s<=a;++s)o.setValue(i,s,t*r.getValue(i,s));return o},st.axty=function(t,r,n,o){if(!(r instanceof st))throw new Error("second input must be a matrix");if(!(n instanceof st))throw new Error("third input must be a matrix");if(r.nbColumns!==n.nbColumns)throw new Error("matrices sizes do not match: ("+r.nbRows+","+n.nbColumns+") - ("+n.nbRows+","+n.nbColumns+")");for(var e=b(r.nbRows,n.nbRows,o),a=0;a<r.nbRows;++a)for(var i=0;i<n.nbRows;++i){for(var s=e.data[a*e.nbColumns+i]=0;s<r.nbColumns;++s)e.data[a*e.nbColumns+i]+=r.data[a*r.nbColumns+s]*n.data[i*n.nbColumns+s];e.data[a*e.nbColumns+i]=t*e.data[a*e.nbColumns+i]}return e},st.atxy=function(t,r,n,o){if(!(r instanceof st))throw new Error("second input must be a matrix");if(!(n instanceof st))throw new Error("third input must be a matrix");if(r.nbRows!==n.nbRows)throw new Error("matrices sizes do not match: ("+r.nbRows+","+n.nbColumns+") - ("+n.nbRows+","+n.nbColumns+")");for(var e=b(r.nbColumns,n.nbColumns,o),a=0,i=0;i<r.nbColumns;++i){for(var s=t*r.data[a*r.nbColumns+i],u=0;u<n.nbColumns;++u)e.data[i*e.nbColumns+u]=0;for(u=0;u<n.nbColumns;++u)e.data[i*e.nbColumns+u]+=s*n.data[a*n.nbColumns+u]}for(a=1;a<r.nbRows;++a)for(i=0;i<r.nbColumns;++i)for(s=t*r.data[a*r.nbColumns+i],u=0;u<n.nbColumns;++u)e.data[i*e.nbColumns+u]+=s*n.data[a*n.nbColumns+u];return e},st.diagonal=function(t,r){if(!(t instanceof st&&t.isVector()))throw new Error("first input must be a vector");for(var n=t.nbRows,o=b(n,n,r),e=0;e<n;++e){for(var a=0;a<n;++a)o.data[e*n+a]=0;o.data[e*n+e]=t.data[e]}return o},st.fillSymetric=function(t,r,n){if(t<1)throw new Error("input number of rows and columns out of bounds: "+t);for(var o=b(t,t,n),e=0;e<t;++e){for(var a=0;a<e;++a)o.data[e*t+a]=o.data[a*t+e];for(a=e;a<o.nbColumns;++a)o.data[e*t+a]=r(e+1,a+1)}return o},st.fill=function(t,r,n,o){if(t<1)throw new Error("input number of rows out of bounds: "+t);if(r<1)throw new Error("input number of columns out of bounds: "+r);for(var e=b(t,r,o),a=0;a<t;++a)for(var i=0;i<r;++i)e.data[a*r+i]=n(a+1,i+1);return e},st.zeros=function(t,r,n){for(var o=b(t,r,n),e=t*r,a=0;a<e;++a)o.data[a]=0;return o},st.ones=function(t,r){for(var n=b(t,r),o=t*r,e=0;e<o;++e)n.data[e]=1;return n},st.identity=function(t){for(var r=b(t,t),n=t*t,o=0;o<n;++o)o%(t+1)==(r.data[o]=0)&&(r.data[o]=1);return r},st.vectorHadamardProduct=function(t,r){return st.elementwiseProduct(t,r)},st.vectorDotProduct=function(t,r){if(!t.isVector())throw new Error("first argument must be a vector");if(!r.isVector())throw new Error("second argument must be a vector");if(t.nbRows!==r.nbRows)throw new Error("Vectors sizes do not match: ("+t.nbRows+") - ("+r.nbRows+")");for(var n=0,o=t.nbRows,e=0;e<o;++e)n+=t.data[e]*r.data[e];return n},st.qrDecomposition=function(t,r){function n(t,r){var n,o,e;if(0==r)n=0<=t?1:-1,o=0,e=Math.abs(t);else if(0==t)o=(n=0)<=r?1:-1,e=Math.abs(r);else if(Math.abs(t)>Math.abs(r)){o=(a=r/t)*(n=1/(i=(0<=t?1:-1)*Math.sqrt(1+a*a))),e=t*i}else{var a,i;n=(a=t/r)*(o=1/(i=(0<=r?1:-1)*Math.sqrt(1+a*a))),e=r*i}return[n,-o,e]}void 0===r&&(r={});var o=r.qLess||!1;if(!(t instanceof st))throw new Error("first input must be a matrix");if(t.nbRows<t.nbColumns)throw new Error("matrix has more columns than rows: ("+t.nbRows+") v.s. ("+t.nbColumns+")");var e=t.nbRows,a=t.nbColumns,i=new st(t),s=null;o||(s=st.identity(e));for(var u=1;u<=a;++u)for(var h=e;u+1<=h;--h){var f=(h-2)*i.nbColumns+(u-1),l=(h-1)*i.nbColumns+(u-1),m=n(i.data[f],i.data[l]),w=m[0],d=m[1],c=m[2];i.data[f]=c,i.data[l]=0;for(var b=u+1;b<=a;++b){var v=(h-2)*i.nbColumns+(b-1),p=(h-1)*i.nbColumns+(b-1),y=i.data[v],g=i.data[p];i.data[v]=w*y-d*g,i.data[p]=d*y+w*g}if(!o)for(b=1;b<=e;++b){var x=(b-1)*s.nbColumns+(h-2),C=(b-1)*s.nbColumns+(h-1);y=s.data[x],g=s.data[C];s.data[x]=w*y-d*g,s.data[C]=d*y+w*g}}return o?i:[s,i]},st.svdDecomposition=function(t,r){void 0===r&&(r={});var n=r.eps||1e-16,o=r.maxIter||100,e=r.svdForm||"thin";if(!(t instanceof st))throw new Error("first input must be a matrix");if(t.nbRows<t.nbColumns)throw new Error("matrix has more columns than rows: "+t.nbColumns+" v.s. "+t.nbRows);for(var a=t.nbRows,i=t.nbColumns,s=new st(t),u=s.matrixNorm("frobenius"),h=st.identity(i),f=0,l="function"==typeof Float64Array?new Float64Array(i):new Array(i);;){if(++f,-1!==o&&o<f)throw new Error("maximum number of iterations reached: "+o);for(var m=1;m<=i;++m){var w=s.vectorNorm("two","column",m);l[m-1]=w*w}var d=!0;for(m=2;m<=i;++m)for(var c=1;c<=m-1;++c){for(var b=l[c-1],v=l[m-1],p=0,y=1;y<=a;++y)p+=s.data[(y-1)*s.nbColumns+(c-1)]*s.data[(y-1)*s.nbColumns+(m-1)];if(!(Math.abs(p)<=n*Math.sqrt(a*b*v))&&!(Math.sqrt(b)<=n*u||Math.sqrt(v)<=n*u)){d=!1;var g=(b-v)/(2*p),x=(0<=g?1:-1)/(Math.abs(g)+Math.sqrt(1+g*g)),C=1/Math.sqrt(1+x*x),R=C*x;for(y=1;y<=a;++y){var A=s.data[(y-1)*s.nbColumns+(c-1)],E=s.data[(y-1)*s.nbColumns+(m-1)];s.data[(y-1)*s.nbColumns+(c-1)]=C*A+R*E,s.data[(y-1)*s.nbColumns+(m-1)]=-R*A+C*E}l[c-1]+=x*p,l[m-1]-=x*p;for(y=1;y<=i;++y){A=h.data[(y-1)*h.nbColumns+(c-1)],E=h.data[(y-1)*h.nbColumns+(m-1)];h.data[(y-1)*h.nbColumns+(c-1)]=C*A+R*E,h.data[(y-1)*h.nbColumns+(m-1)]=-R*A+C*E}}}if(1==d)break}var M="function"==typeof Float64Array?new Float64Array(i):new Array(i),V="function"==typeof Uint32Array?new Uint32Array(i):new Array(i);for(m=1;m<=i;++m){var z=Math.sqrt(l[m-1]);M[m-1]=z,V[m-1]=m}V.sort(function(t,r){return M[r-1]-M[t-1]});var _=st.zeros(a,i),P=st.zeros(i,i),I=st.zeros(i,i);for(m=1;m<=i;++m){var O=V[m-1],N=M[O-1];if(0!=(P.data[(m-1)*P.nbColumns+(m-1)]=N))for(c=1;c<=a;++c)_.data[(c-1)*_.nbColumns+(m-1)]=s.data[(c-1)*s.nbColumns+(O-1)]/N;for(c=1;c<=i;++c)I.data[(c-1)*I.nbColumns+(m-1)]=h.data[(c-1)*h.nbColumns+(O-1)]}if("thin"==e)return[_,P,I];var q=st.qrDecomposition(_)[0],S=st.zeros(a,a),U=st.zeros(a,i);for(m=1;m<=i;++m){O=V[m-1],N=M[O-1];if(0!=(U.data[(m-1)*U.nbColumns+(m-1)]=N))for(c=1;c<=a;++c)S.data[(c-1)*S.nbColumns+(m-1)]=_.data[(c-1)*_.nbColumns+(m-1)];else for(c=1;c<=a;++c)S.data[(c-1)*S.nbColumns+(m-1)]=q.data[(c-1)*q.nbColumns+(m-1)]}for(m=i+1;m<=a;++m)for(c=1;c<=a;++c)S.data[(c-1)*S.nbColumns+(m-1)]=q.data[(c-1)*q.nbColumns+(m-1)];return"full"==e?[S,U,I]:void 0},st.nullSpace=function(t,r){void 0===r&&(r={});var n=r.eps||void 0;if(!(t instanceof st))throw new Error("first input must be a matrix");var o=t.nbRows,e=t.nbColumns,a=null;if(e<=o){var i=(l=st.svdDecomposition(t,{maxIter:-1}))[0],s=l[1],u=l[2];for(void 0===n&&(n=o*(A(s.data[0])-s.data[0])),m=e;1<=m&&!(s.data[(m-1)*s.nbColumns+(m-1)]>n);--m);if((w=m)==e)a=st.zeros(e,1);else{a=new st.zeros(e,e-w);for(var h=w+1;h<=e;++h)for(var f=1;f<=e;++f)a.data[(f-1)*a.nbColumns+(h-(w+1)+1-1)]=u.data[(f-1)*u.nbColumns+(h-1)]}}else{var l,m,w;i=(l=st.svdDecomposition(t.transpose(),{maxIter:-1,svdForm:"full"}))[0],s=l[1],u=l[2];for(void 0===n&&(n=e*(A(s.data[0])-s.data[0])),m=o;1<=m&&!(s.data[(m-1)*s.nbColumns+(m-1)]>n);--m);if((w=m)==o)a=st.zeros(e,1);else{var d=new st.zeros(e,w);for(h=1;h<=w;++h)for(f=1;f<=e;++f)d.data[(f-1)*d.nbColumns+(h-1)]=i.data[(f-1)*i.nbColumns+(h-1)];var c=st.qrDecomposition(d)[0];for(a=new st.zeros(e,e-w),h=w+1;h<=e;++h)for(f=1;f<=e;++f)a.data[(f-1)*a.nbColumns+(h-(w+1)+1-1)]=c.data[(f-1)*c.nbColumns+(h-1)]}}return a},st.linsolveBackSubstitution=function(t,r,n){if(!(t instanceof st))throw new Error("first input must be a matrix");if(!(r instanceof st))throw new Error("second input must be a matrix");if(!t.isSquare())throw new Error("matrix is not square: ("+t.nbRows+","+t.nbColumns+")");if(t.nbRows!==r.nbRows)throw new Error("matrix and second member sizes do not match: ("+t.nbRows+","+t.nbColumns+") - ("+r.nbRows+","+r.nbColumns+")");if(1!==r.nbColumns)throw new Error("b is not a vector: ("+r.nbRows+","+r.nbColumns+")");for(var o=t.nbColumns,e=b(o,1,n),a=o;1<=a;--a){e.data[a-1]=r.data[a-1];for(var i=a+1;i<=o;++i)e.data[a-1]=e.data[a-1]-t.data[(a-1)*t.nbColumns+(i-1)]*e.data[i-1];var s=t.data[(a-1)*t.nbColumns+(a-1)];if(0==s)throw new Error("input matrix is not invertible: zero diagonal coefficient at index "+a);e.data[a-1]=e.data[a-1]/s}return e},st.linsolveExtendedKaczmarz=function(t,r,n){void 0===n&&(n={});var o=n.eps||1e-12,e=n.maxIter||1e5,a=!1;if(void 0!==n.randomized&&(a=n.randomized),!(t instanceof st))throw new Error("first input must be a matrix");if(!(r instanceof st))throw new Error("second input must be a matrix");if(t.nbRows!==r.nbRows)throw new Error("matrix and second member sizes do not match: ("+t.nbRows+","+t.nbColumns+") - ("+r.nbRows+","+r.nbColumns+")");if(1!==r.nbColumns)throw new Error("b is not a vector: ("+r.nbRows+","+r.nbColumns+")");var i=t.nbRows,s=t.nbColumns,u=st.zeros(s,1),h=st.copy(r),f=st.zeros(i,1),l=st.zeros(i,1),m=st.zeros(i,1),w=t.matrixNorm("frobenius"),d=w*w;if(0===w)return u;for(var c="function"==typeof Float64Array?new Float64Array(i):new Array(i),b=1;b<=i;++b){var v=t.vectorNorm("two","row",b);c[b-1]=v*v}for(var p="function"==typeof Float64Array?new Float64Array(s):new Array(s),y=1;y<=s;++y){var g=t.vectorNorm("two","column",y);p[y-1]=g*g}if(0==a)for(var x=0;;){if(++x,-1!==e&&e<=x)throw new Error("maximum number of iterations reached: "+e);for(b=1;b<=i;++b)if(0!=c[b-1]){var C=0;for(y=1;y<=s;++y)C+=t.data[(b-1)*t.nbColumns+(y-1)]*u.data[(y-1)*u.nbColumns];var R=C-(r.data[(b-1)*r.nbColumns+0]-h.data[(b-1)*h.nbColumns+0]);for(y=1;y<=s;++y)u.data[(y-1)*u.nbColumns]-=R/c[b-1]*t.data[(b-1)*t.nbColumns+(y-1)]}for(y=1;y<=s;++y)if(0!=p[y-1]){var A=0;for(b=1;b<=i;++b)A+=t.data[(b-1)*t.nbColumns+(y-1)]*h.data[(b-1)*h.nbColumns+0];for(b=1;b<=i;++b)h.data[(b-1)*h.nbColumns+0]-=A/p[y-1]*t.data[(b-1)*t.nbColumns+(y-1)]}var E=u.vectorNorm("two");if(m=st.xy(t,u,m),l=st.xmy(r,h,l),(I=(f=st.xmy(m,l,f)).vectorNorm("two"))<=o*w*E)break}else{var M=st.zeros(s,1),V="function"==typeof Float64Array?new Float64Array(i):new Array(i);for(b=1;b<=i;++b)V[b-1]=c[b-1]/d;var z=new N(V),_="function"==typeof Float64Array?new Float64Array(s):new Array(s);for(y=1;y<=s;++y)_[y-1]=p[y-1]/d;var P=new N(_);for(x=0;;){if(++x,-1!==e&&e<=x)throw new Error("maximum number of iterations reached: "+e);for(b=z.sample()+1,C=0,y=1;y<=s;++y)C+=t.data[(b-1)*t.nbColumns+(y-1)]*u.data[(y-1)*u.nbColumns];for(R=C-(r.data[(b-1)*r.nbColumns+0]-h.data[(b-1)*h.nbColumns+0]),y=1;y<=s;++y)u.data[(y-1)*u.nbColumns]-=R/c[b-1]*t.data[(b-1)*t.nbColumns+(y-1)];for(y=P.sample()+1,A=0,b=1;b<=i;++b)A+=t.data[(b-1)*t.nbColumns+(y-1)]*h.data[(b-1)*h.nbColumns+0];for(b=1;b<=i;++b)h.data[(b-1)*h.nbColumns+0]-=A/p[y-1]*t.data[(b-1)*t.nbColumns+(y-1)];if(x%8*Math.min(i,s)==0){E=u.vectorNorm("two");m=st.xy(t,u,m),l=st.xmy(r,h,l);var I=(f=st.xmy(m,l,f)).vectorNorm("two"),O=(M=st.txy(t,h,M)).vectorNorm("two");if(I<=o*w*E&&O<=o*d*E)break}}}return u},p.covarianceMatrix=function(t){for(var r=arguments,n=b(r.length,r.length),o=0;o<n.nbRows;++o){for(var e=0;e<o;++e)n.data[o*n.nbColumns+e]=n.data[e*n.nbColumns+o];for(e=o;e<n.nbColumns;++e)n.data[o*n.nbColumns+e]=h(r[o],r[e])}return u(n),n},p.sampleCovarianceMatrix=function(t){for(var r,n,o,e=arguments,a=b(e.length,e.length),i=0;i<a.nbRows;++i){for(var s=0;s<i;++s)a.data[i*a.nbColumns+s]=a.data[s*a.nbColumns+i];for(s=i;s<a.nbColumns;++s)a.data[i*a.nbColumns+s]=(n=e[s],void 0,o=(r=e[i]).length,h(r,n)*o/(o-1))}return u(a),a},st.prototype.toCovarianceMatrix=function(){new st(this);return u(this),this},(p.BitSet_=ut).populationCount=function(t){return t=(t=(858993459&(t-=t>>>1&1431655765))+(t>>>2&858993459))+(t>>>4)&252645135,t+=t>>>8,63&(t+=t>>>16)},ut.prototype={constructor:ut,resize:function(t){var r=this.words.length;if(!(r<<this.WORD_LOG>t)){var n=t+this.WORD_LENGTH>>>this.WORD_LOG;if("function"==typeof Uint32Array){var o=new Uint32Array(n);o.set(this.words),this.words=o}else{this.words[n-1]=0;for(var e=r;e<n-1;++e)this.words[e]=0}}},toString:function(){for(var t="",r=this.words.length,n=0;n<r;++n){var o="";t+=(o="function"==typeof Uint32Array?this.words[n].toString(2):(this.words[n]>>>0).toString(2)).length>=this.WORD_LENGTH?o:new Array(this.WORD_LENGTH-o.length+1).join("0")+o}return t},set:function(t){return this.words.length<<this.WORD_LOG<=t&&this.resize(t),this.words[t>>>this.WORD_LOG]|=1<<t,this},setRange:function(t,r){this.words.length<<this.WORD_LOG<=r&&this.resize(r);for(var n=t;n<=r;++n)this.words[n>>>this.WORD_LOG]|=1<<n;return this},unset:function(t){return this.words.length<<this.WORD_LOG<=t&&this.resize(t),this.words[t>>>this.WORD_LOG]&=~(1<<t),this},get:function(t){return 0!=(this.words[t>>>this.WORD_LOG]&1<<t)},clear:function(){return this.words="function"==typeof Uint32Array?new Uint32Array(0):new Array(0),this},flip:function(t){return this.words.length<<this.WORD_LOG<=t&&this.resize(t),this.words[t>>>this.WORD_LOG]^=1<<t,this},isEmpty:function(){for(var t=this.words.length,r=0;r<t;++r)if(0!=this.words[r])return!1;return!0},nbSetBits:function(){for(var t=0,r=this.words.length,n=0;n<r;++n)t+=ut.populationCount(0|this.words[n]);return t},toArray:function(){for(var t=new Array(this.nbSetBits()),r=0,n=this.words.length,o=0;o<n;++o)for(var e=this.words[o];0!=e;){var a=e&-e;t[r++]=(o<<this.WORD_LOG)+ut.populationCount(a-1|0),e^=a}return t}},p.aliasMethodSampler_=N,p.randomCompositionsIterator_=function(t,r){this.n=t,this.k=r,this.ranksb=new g(t+r-1,r-1),this.r="function"==typeof Uint32Array?new Uint32Array(r):new Array(r),this.next=function(){for(var t=this.ranksb.next(),r=0;r<this.k-1;++r)this.r[r]=t[r];this.r[this.k-1]=this.n+this.k;var n=0;for(r=1;r<=this.k;++r){var o=this.r[r-1];this.r[r-1]=o-n-1,n=o}return this.r.slice(0)}},p.compositionsIterator_=o,p.subsetsIterator_=v,p.kSubsetsIterator_=y,p.randomKSubsetIterator_=g,p.binomial_=x,p.geometricCenter_=C,p.geometricMedian_=R,p.max_=ht,p.median_=function(t,r){var n=t.length;return W(t.slice(),Math.ceil(n/2),r)},p.select_=W,p.hypot_=f,p.rank_=d,p.ftca_=E,p.normcdf_=function(t){return V(t)},p.norminv_=s,p.hypersphereRandomSampler_=function(t){this.n=t,this.x="function"==typeof Float64Array?new Float64Array(t):new Array(t),this.sample=function(){for(var t=0,r=0;r<this.n;++r){for(var n=Math.random();0===n;)n=Math.random();var o=s(n);t+=(this.x[r]=o)*o}var e=Math.sqrt(t);for(r=0;r<this.n;++r)this.x[r]=this.x[r]/e;return this.x.slice()}},p.lpsolvePDHG_=m,p.qpsolveGSMO_=z,p.qksolveBS_=S,p.ccpsolveFISTA_=r,p.simplexRationalRounding_=e,p.simplexRandomSampler_=w,p.simplexDirectionRandomSampler_=function(t){this.n=t,this.x="function"==typeof Float64Array?new Float64Array(t):new Array(t),this.sample=function(){for(var t=0,r=0;r<this.n;++r){for(var n=Math.random();0===n;)n=Math.random();var o=s(n);t+=this.x[r]=o}var e=t/this.n,a=0;for(r=0;r<this.n;++r)this.x[r]=this.x[r]-e,a+=this.x[r]*this.x[r];var i=Math.sqrt(a);for(r=0;r<this.n;++r)this.x[r]=this.x[r]/i;return this.x.slice(0)}},p.simplexGridSampler_=_,p.simplexGridSearch_=i,p.simplexEuclidianProjection_=l,p.simplexSparseEuclidianProjection_=function(n,t){var r=n.length;if(t===r)return l(n);for(var o="function"==typeof UInt32Array?new UInt32Array(r):new Array(r),e=0;e<r;++e)o[e]=e;W(o,t,function(t,r){return n[r]-n[t]});var a=n.slice(0,t);for(e=0;e<t;++e)a[e]=n[o[e]];var i=l(a),s="function"==typeof Float64Array?new Float64Array(r):new Array(r);for(e=0;e<t;++e)s[o[e]]=i[e];for(e=t;e<r;++e)s[o[e]]=0;return s},p.clusterRiskParityWeights=function(t,r){void 0===r&&(r={});var n=r.clusteringMode||"ftca",o=(t=new st(t).toCovarianceMatrix(t)).nbRows,e=[];if("manual"===n){e=r.clusters||[];for(var a=new Array(o),i=0;i<a.length;++i)a[i]=0;for(var s=0;s<e.length;++s){if(0===e[s].length)throw new Error("empty cluster at index: "+s);for(var u=0;u<e[s].length;++u){var h=e[s][u];if(h<1||o<h)throw new Error("asset index out of bounds: "+h);a[h-1]++}}for(i=0;i<a.length;++i)if(1!==a[i])throw 0===a[i]?new Error("missing asset index: "+(i+1)):1<a[i]?new Error("duplicate asset index: "+(i+1)):new Error("unknown error")}else{if("ftca"!==n)throw new Error("unsupported clustering method");e=E(t.getCorrelationMatrix().toRowArray(),r.ftcaThreshold)}var f=e.length,l=st.zeros(f,o);for(i=0;i<f;++i){var m=e[i].slice().sort(function(t,r){return t-r}),w=t.submatrix(m,m),d=p.equalRiskContributionWeights(w,r);for(s=0;s<d.length;++s)l.setValueAt(i+1,m[s],d[s])}var c=l.transpose(),b=st.xy(l,st.xy(t,c)),v=p.equalRiskContributionWeights(b,r);return st.xy(c,new st(v)).toArray()},p.equalRiskBoundingWeights=function(t,r){void 0===r&&(r={}),r.outputPortfolioVolatility=!0;var n=(t=new st(t)).nbRows,o=1/0,e=[],a=[],i=new v(n),s=i.next();for(s=i.next();-1!=s;){var u=s,h=t.submatrix(u,u),f=p.equalRiskContributionWeights(h,r),l=f[0],m=f[1],w=m*m/u.length;w<o&&(o=w,e=u,a=l);s=i.next()}for(var d=st.zeros(n,1),c=0;c<e.length;++c)d.setValueAt(e[c],1,a[c]);return d.toArray()},p.equalRiskBudgetWeights=function(t,r){var n=new st(t).elemMap(function(t,r,n){return 1/Math.sqrt(n)});return(n=n.normalize(n)).toArray()},p.equalRiskContributionWeights=function(t,r){var n=(t=new st(t)).nbRows,o=st.fill(n,1,function(t,r){return 1/n});return p.riskBudgetingWeights(t,o,r)},p.equalWeights=function(n,t){return st.fill(n,1,function(t,r){return 1/n}).toArray()},p.globalMinimumVarianceWeights=function(t,r){void 0===r&&(r={}),void 0===r.constraints&&(r.constraints={}),void 0===r.eps&&(r.eps=1e-8),void 0===r.maxIter&&(r.maxIter=1e4);var n=r.eps,o=r.maxIter,e=r.constraints.minWeights,a=r.constraints.maxWeights,i=(t=new st(t)).nbRows,s=st.zeros(i,1),u=st.ones(i,1),h=t,f=s,l=u,m=s;e&&(m=new st(e));var w=u;return a&&(w=new st(a)),z(h,f,l,1,m,w,{eps:n,maxIter:o})[0].toArray()},p.computeCornerPortfolios_=O,p.meanVarianceOptimizationWeights=function(t,r,n){void 0===n&&(n={constraints:{}}),void 0===n.constraints&&(n.constraints={});var o=n.optimizationMethod;if(void 0===o)throw new Error("missing mean-variance optimization method");if("targetReturn"!==o&&"targetVolatility"!==o&&"minimumVariance"!==o&&"maximumTargetVolatility"!==o)throw new Error("unsupported mean-variance optimization method");var e=n.constraints.return;if("targetReturn"===o&&void 0===e)throw new Error("missing mean-variance optimization method return constraint");var a=n.constraints.volatility;if("targetVolatility"===o&&void 0===a)throw new Error("missing mean-variance optimization method volatility constraint");var i=n.constraints.maxVolatility;if("maximumTargetVolatility"===o&&void 0===i)throw new Error("missing mean-variance optimization method maximum volatility constraint");var s,u=O(t=new st(t),r=new st(r),n);if("targetReturn"==o){if(0==(s=P(t,e,u)).length)throw new Error("return not reachable");s=s[0]}else if("targetVolatility"==o){if(0==(s=I(r,a,u)).length)throw new Error("volatility not reachable");s=s[0]}else if("minimumVariance"==o)s=function(t){if(0!==t.length)return t[t.length-1][0];throw new Error("internal error: empty list of corner portfolios")}(u);else{if("maximumTargetVolatility"!=o)throw new Error("internal error");s=function(n,o,t,r,e){function a(t,r){return Math.sqrt(st.vectorDotProduct(st.xy(t,r),r))}var i,s=o.nbColumns,u=r[0][0],h=a(o,u);if(h+1e-8<t)i=u;else{var f=r[r.length-1][0],l=a(o,f);if(t<l-1e-8){var m,w=st.fill(s+1,1,function(t,r){return t<=s?n.getValue(t,1):0}),d=st.fill(s+1,s+1,function(t,r){return t<=s&&r<=s?o.getValue(t,r):0}),c=O(w,d,e);if(1===c.length){if(m=c[0][0],1!=c[0][0].getValue(s+1,1))throw new Error("internal error")}else{if(0===(b=I(d,t,c)).length)throw new Error("internal error");m=b[0]}i=st.fill(s,1,function(t,r){if(t<=s)return m.getValue(t,1)})}else{var b;if(0===(b=I(o,t,r)).length)throw new Error("internal error");i=b[0]}}return i}(t,r,i,u,{maxIter:n.maxIter,constraints:n.constraints})}return s.toArray()},p.maximumSharpeRatioWeights=function(t,r,n,o){function s(t,r){return st.vectorDotProduct(t,r)}function u(t,r){return Math.sqrt(st.vectorDotProduct(st.xy(t,r),r))}function B(t,r,n,o){var e=s(t,o),a=e-n,i=u(r,o);return Math.abs(i)<1e-8&&(i=1e-8),[a/i,e,i]}function e(t,r,n,o,e,a,i){var s=B(t,r,n,e),u=s[0],h=s[1],f=s[2],l=f*f,m=B(t,r,n,i),w=m[0],d=m[1],c=m[2],b=c*c,v=h-d,p=d-n,y=v*v,g=2*v*p,x=p*p,C=st.vectorDotProduct(st.xy(r,e),i),R=l+b-2*C,A=-2*(b-C),E=y*A-g*R,M=g*b-x*A,V=2*(y*b-x*R)/2,z=0<=V?1:-1,_=V*V-E*M;if(_<0)throw new Error("internal error, the covariance matrix might not be semi-definite positive");var P=-(V+z*Math.sqrt(_)),I=P/E,O=M/P,N=[[e,u],[i,w]];if(0<I&&I<1){var q=st.fill(e.nbRows,1,function(t,r){return I*e.getValue(t,1)+(1-I)*i.getValue(t,1)}),S=B(t,r,n,q)[0];N.push([q,S])}if(0<O&&O<1){var U=st.fill(e.nbRows,1,function(t,r){return O*e.getValue(t,1)+(1-O)*i.getValue(t,1)}),F=B(t,r,n,U)[0];N.push([U,F])}return ht(N,function(t,r){return t[1]-r[1]})[0]}var a=O(t=new st(t),r=new st(r),o);if(u(r,a[a.length-1][0])<1e-8){if(0==(h=I(r,1e-8,a)).length)throw new Error("no corner portfolio with a strictly positive volatility: the covariance matrix might not be semi-definite positive");var i=h[0];a[f=h[1]]=[i,-1],a.length=f+1}if(s(t,a[a.length-1][0])<n+1e-8){var h;if(0==(h=P(t,n+1e-8,a)).length)throw new Error("no corner portfolio with a strictly positive excess return");var f;i=h[0];a[f=h[1]]=[i,-1],a.length=f+1}var l=function(t,r,n,o){var e=o.length-1,a=0,i=o[e][0],s=o[a][0],u=B(t,r,n,i);if(B(t,r,n,s),e==a)return[e,i,u];for(;e-a!=1;){var h=Math.floor(a+(e-a)/2),f=o[h][0],l=B(t,r,n,f),m=h+1,w=o[m][0],d=B(t,r,n,w);if(l[0]>d[0])e=h,i=f,u=l;else{if(!(l[0]<d[0])){e=m,i=w,u=d,a=h,s=f,l;break}a=h,s=f,l}}return[e,i,u]}(t,r,n,a),m=l[0],w=l[1],d=[[w,l[2][0]]],c=m+1;if(c<=a.length-1){var b=e(t,r,n,0,a[c][0],0,w);d.push(b)}var v=m-1;if(0<=v){var p=e(t,r,n,0,w,0,a[v][0]);d.push(p)}return ht(d,function(t,r){return t[1]-r[1]})[0][0].toArray()},p.meanVarianceEfficientFrontierPortfolios=function(t,r,n){void 0===n&&(n={constraints:{}});var o=n.nbPortfolios||100,e=O(t=new st(t),r=new st(r),n),a=r.nbColumns,i=new Array(o);if(0==e.length)throw new Error("efficient frontier made of no corner portfolios: internal error");if(1==e.length){if(1!=o)throw new Error("efficient frontier made of only one corner portfolio: only one efficient portfolio can be computed");var s=e[0][0],u=st.vectorDotProduct(t,s),h=Math.sqrt(st.vectorDotProduct(st.xy(r,s),s));return[[s.toArray(),u,h]]}if(o<=1)throw new Error("efficient frontier made of several corner portfolios: at least two efficient portfolios must be computed");var f=e[e.length-1][1],l=e[0][1],m=(l-f)/(o-1),w=f,d=e.length-1,c=d-1,b=e[d][1],v=e[c][1],p=e[d][0],y=e[c][0],g=e[d][0];u=st.vectorDotProduct(t,g),h=Math.sqrt(st.vectorDotProduct(st.xy(r,g),g));i[0]=[g.toArray(),u,h];for(var x=1;x<o-1;++x){for(w=f+x*m;v<w;)--c,b=e[--d][1],v=e[c][1],p=e[d][0],y=e[c][0];var C=(w-b)/(v-b);s=st.fill(a,1,function(t,r){return(1-C)*p.getValue(t,1)+C*y.getValue(t,1)}),u=st.vectorDotProduct(t,s),h=Math.sqrt(st.vectorDotProduct(st.xy(r,s),s));i[x]=[s.toArray(),u,h]}w=l;var R=e[c=(d=1)-1][0];u=st.vectorDotProduct(t,R),h=Math.sqrt(st.vectorDotProduct(st.xy(r,R),R));return i[o-1]=[R.toArray(),u,h],i},p.meanVarianceCornerPortfolios=function(t,r,n){for(var o=O(t=new st(t),r=new st(r),n),e=new Array(o.length),a=0;a<o.length;++a){var i=o[a][0],s=st.vectorDotProduct(t,i),u=Math.sqrt(st.vectorDotProduct(st.xy(r,i),i));e[o.length-1-a]=[i.toArray(),s,u]}return e},p.minimaxWeights=function(n,t){void 0===t&&(t={constraints:{}}),void 0===t.constraints&&(t.constraints={});var r=!0;void 0!==t.constraints.fullInvestment&&(r=t.constraints.fullInvestment);var o=t.outputMinimumPortfolioReturn,e=n.length,a=n[0].length,i=st.fill(e+1,1,function(t,r){return t<=e?0:-1}),s=null,u=null;r&&(s=st.fill(1,e+1,function(t,r){return r<=e?1:0}),u=st.ones(1,1));var h=m(s,u,st.fill(a+(r?0:1),e+1,function(t,r){return t<=a?r<=e?-n[r-1][t-1]:1:t==a+1?r<=e?1:0:void 0}),st.fill(a+(r?0:1),1,function(t,r){return t<=a?0:t==a+1?1:void 0}),i,st.fill(e+1,1,function(t,r){return t<=e?0:-1/0}),st.fill(e+1,1,function(t,r){return t<=e?1:1/0}),{maxIter:-1})[0],f=h.toArray(function(t,r,n){return t!=e+1}),l=h.data[e];return!0===o?[f,l]:f},p.minimumCorrelationWeights=function(t,r){var n=(t=new st(t).toCovarianceMatrix()).getVariancesVector(),o=n.elemMap(function(t,r,n){return 1/Math.sqrt(n)}),e=t.getCorrelationMatrix(),a=e.nbRows;if(a<=2)return p.equalRiskBudgetWeights(n,r);for(var i=e.toArray(function(t,r,n){return t<r}),s=M(i),u=c(i),h=e.elemMap(function(t,r,n){return t==r?0:1-V((n-s)/u)}),f=h.toRowArray(function(t,r,n){return t!=r}),l=new Array(a),m=0;m<a;++m)l[m]=M(f[m]);var w=new st(d(l,0),1).normalize();return w=st.xy(h,w).normalize(),(w=st.vectorHadamardProduct(w,o).normalize()).toArray()},p.mostDiversifiedWeights=function(t,r){void 0===r&&(r={});var n=r.eps||1e-4,o=r.maxIter||1e4,e=(t=new st(t)).nbRows,a=st.zeros(e,1),i=st.fill(e,1,function(t,r){return Number.MAX_VALUE});return z(t,a,t.diagonal().elemMap(function(t,r,n){return Math.sqrt(n)}),1,a,i,{eps:n,maxIter:o})[0].normalize().toArray()},p.numericalOptimizationWeights=function(t,r,n){if(void 0===n&&(n={}),void 0===n.constraints&&(n.constraints={}),void 0===n.optimizationMethodParams&&(n.optimizationMethodParams={}),void 0===n.optimizationMethod&&(n.optimizationMethod="grid-search"),"grid-search"===n.optimizationMethod&&void 0===n.optimizationMethodParams.k&&(n.optimizationMethodParams.k=t),"grid-search"===n.optimizationMethod)return i(r,t,n.optimizationMethodParams.k,n.constraints.minWeights,n.constraints.maxWeights);throw new Error("unsupported optimisation method")},p.proportionalMinimumVarianceWeights=function(t,r){for(var n=(t=new st(t)).nbRows,o=t.toRowArray(),e=new Array(n),a=0;a<n;++a)e[a]=M(o[a]);var i=M(e),s=c(e),u=new st(e,1).elemMap(function(t,r,n){return 1-V((n-i)/s)});u=u.normalize(u);var h=t.diagonal().elemMap(function(t,r,n){return 1/n}).normalize();return(u=st.vectorHadamardProduct(u,h).normalize()).toArray()},p.randomSubspaceOptimizationWeights=function(t,r,n){if(void 0===n&&(n={}),void 0===n.constraints&&(n.constraints={}),void 0===n.subsetPortfolioOptimizationMethodParams&&(n.subsetPortfolioOptimizationMethodParams={}),void 0===n.subsetPortfolioOptimizationMethodParams.constraints&&(n.subsetPortfolioOptimizationMethodParams.constraints={}),t<=1)return[1];var o=n.sizeSubsets;if(void 0===o&&(o=Math.max(2,Math.floor(Math.sqrt(t)))),o<=1||t+1<=o)throw new Error("the size of the subsets of assets must be between 2 and "+t.toString());var e=n.subsetsGenerationMethod;void 0===e&&(e="random");var a,i=n.nbRandomSubsets;if(void 0===i&&(i=128),o===t&&(i=1),"random"===e)a=i;else{if("deterministic"!==e)throw new Error("unsupported subsets of assets generation method");a=x(t,o)}var s=n.subsetsAggregationMethod;if(void 0===s&&(s="average"),"average"!==s&&"median"!==s)throw new Error("unsupported aggregation method");var u,h=n.maxInfeasibleSubsetsRatio;if(void 0===h&&(h=0),"random"===e)u=new g(t,o,!1);else{if("deterministic"!==e)throw new Error("unsupported subsets generation method");u=new y(t,o,!1)}var f=n.subsetPortfolioOptimizationMethodParams,l=0,m=new Array(a);n.constraints.minWeights&&(f.constraints.minWeights="function"==typeof Float64Array?new Float64Array(o):new Array(o)),n.constraints.maxWeights&&(f.constraints.maxWeights="function"==typeof Float64Array?new Float64Array(o):new Array(o));for(var w=0;w<a;++w){var d=u.next();if(n.constraints.minWeights)for(var c=0;c<o;++c)f.constraints.minWeights[c]=n.constraints.minWeights[d[c]-1];if(n.constraints.maxWeights)for(c=0;c<o;++c)f.constraints.maxWeights[c]=n.constraints.maxWeights[d[c]-1];try{var b=r(d,f);if(b.length!=o)throw new Error("internal error: the portfolio optimization method did not return the expected number of weights")}catch(t){if("infeasible portfolio optimization problem"===t.message)continue;throw t}var v=st.zeros(t,1);for(c=0;c<o;++c)v.setValueAt(d[c],1,b[c]);m[l++]=v}if(0===(m.length=l))throw new Error("no feasible portfolio generated");var p=a-l;if(1<=p&&h<=p/a)throw new Error("too many infeasible portfolios generated");v=null;if("average"==s)v=C(m);else{if("median"!=s)throw new Error("internal error");v=R(m)}return v.toArray()},p.randomSubspaceMeanVarianceOptimizationWeights=function(e,a,t){void 0===t&&(t={}),void 0===t.constraints&&(t.constraints={}),void 0===t.subsetPortfolioOptimizationMethodParams&&(t.subsetPortfolioOptimizationMethodParams={}),void 0===t.subsetPortfolioOptimizationMethodParams.constraints&&(t.subsetPortfolioOptimizationMethodParams.constraints={});e=new st(e);var r=(a=new st(a)).nbColumns;if(void 0===t.sizeSubsets){var n=-Math.sqrt(2*r*(r+3)),o=2.25-1*n,i=n/-(1.5+Math.sqrt(o));t.sizeSubsets=Math.max(2,Math.floor(i))}return t.subsetPortfolioOptimizationMethodParams.subsetMu=st.zeros(t.sizeSubsets,1),t.subsetPortfolioOptimizationMethodParams.subsetSigma=st.zeros(t.sizeSubsets,t.sizeSubsets),p.randomSubspaceOptimizationWeights(r,function(t,r){var n=e.submatrix(t,[1],r.subsetMu),o=a.submatrix(t,t,r.subsetSigma);return p.meanVarianceOptimizationWeights(n,o,r)},t)},p.randomWeights=function(t,r){void 0===r&&(r={constraints:{}});for(var n,o=r.constraints.minAssets||1,e=r.constraints.maxAssets||t,a=Math.floor(Math.random()*(e-o+1))+o,i=new g(t,a).next(),s=new w(a);;){n=s.sample();for(var u=!1,h=0;h<a;++h)if(0==n[h]){u=!0;break}if(!u)break}var f=st.zeros(t,1);for(h=0;h<a;++h){var l=i[h],m=n[h];f.setValueAt(l,1,m)}return f.toArray()},p.riskBudgetingWeights=function(t,r,n){void 0===n&&(n={});for(var o=n.eps||1e-8,e=n.maxIter||1e4,a=n.outputPortfolioVolatility,i=(t=new st(t),r=new st(r),t.nbRows),s=st.fill(i,1,function(t,r){return 1/i}),u=st.xy(t,s),h=Math.sqrt(st.vectorDotProduct(u,s)),f=.5*h-st.vectorDotProduct(r,s.elemMap(function(t,r,n){return Math.log(n)})),l=0,m=!1;!m;){m=!0;for(var w=1;w<=i;++w){var d=s.data[w-1],c=t.data[(w-1)*t.nbColumns+(w-1)],b=u.data[w-1]-s.data[w-1]*c,v=-r.data[w-1]*h,p=b/2,y=0<=p?1:-1,g=p*p-c*v;if(g<0)throw new Error("Negative discriminant during iteration "+l+", covariance matrix might not be semi-definite positive");var x=-(p+y*Math.sqrt(g)),C=x/c,R=0<C?C:v/x;s.data[w-1]=R;for(var A=1;A<=i;++A)u.data[A-1]+=t.data[(A-1)*t.nbColumns+(w-1)]*R,u.data[A-1]-=t.data[(A-1)*t.nbColumns+(w-1)]*d;var E=st.vectorDotProduct(u,s);if(E<0){if(!(-E<1e-12))throw new Error("Negative volatility during iteration "+l+", covariance matrix might not be semi-definite positive");E=0}if(0!=(h=Math.sqrt(E))){var M=s.data[w-1]*u.data[w-1]/h;Math.abs(M-r.data[w-1])>o&&(m=!1)}}var V=.5*h-st.vectorDotProduct(r,s.elemMap(function(t,r,n){return Math.log(n)}));if(Math.abs(V-f)>o&&(m=!1,f=V),e<++l)throw new Error("maximum number of iterations reached: "+e)}var z=s.sum();return s=s.normalize(s),!0===a?[s.toArray(),h/z]:s.toArray()},p.roundedWeights=function(t,r){return e(t,r)},p}(PortfolioAllocation||{}),"undefined"!=typeof module&&(module.exports=PortfolioAllocation);